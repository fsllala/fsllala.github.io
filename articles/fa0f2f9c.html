<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>网络安全修改 | Forward の Blog</title><meta name="author" content="Forward"><meta name="copyright" content="Forward"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="背景网站做完之后，移交给第三方机构进行安全检测，对”安全功能验证观察报告”指出的问题进行了如下修改； 接口重放什么是重放参考文献：基于timestamp和nonce的防止重放攻击方案  重放攻击指的是攻击者通过发送一个目的主机已接受到的包，来达到欺骗系统的目的。其基本原理就是把窃听到的数据原封不动的"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://fsllala.top/articles/fa0f2f9c"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://netlity.fsllala.top/css/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '网络安全修改',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-23 17:14:12'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/onePic.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/wind.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/cursor.css"><link rel="stylesheet" href="/css/cat.css"><link rel="stylesheet" href="/css/readPercent.css"><link rel="stylesheet" href="/css/txMap.css"><link rel="stylesheet" href="/css/avator.css"><div id="myscoll"></div><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/1656236729350avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">55</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">51</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cover.fsllala.top/default_cover_57.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Forward の Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">网络安全修改</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-09T10:23:04.000Z" title="发表于 2023-11-09 18:23:04">2023-11-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-09-23T09:14:12.656Z" title="更新于 2024-09-23 17:14:12">2024-09-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="网络安全修改"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>网站做完之后，移交给第三方机构进行安全检测，对”安全功能验证观察报告”指出的问题进行了如下修改；</p>
<h2 id="接口重放"><a href="#接口重放" class="headerlink" title="接口重放"></a>接口重放</h2><h3 id="什么是重放"><a href="#什么是重放" class="headerlink" title="什么是重放"></a>什么是重放</h3><p>参考文献：<a target="_blank" rel="noopener" href="https://blog.csdn.net/koastal/article/details/53456696?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-3-53456696-blog-114984526.235%5Ev38%5Epc_relevant_anti_t3_base&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-3-53456696-blog-114984526.235%5Ev38%5Epc_relevant_anti_t3_base&utm_relevant_index=4">基于timestamp和nonce的防止重放攻击方案</a></p>
<blockquote>
<p>重放攻击指的是攻击者通过发送一个目的主机已接受到的包，来达到欺骗系统的目的。其基本原理就是把窃听到的数据原封不动的重新发送给接收方(好像修改了数据在发送就不叫重放了)，即使传输的数据是加密的，窃听方不知道具体的数据内容，但是容易知道数据的作用（即使不知道作用也能对系统造成一定破坏），这时就能通过原封不动的重新发送达到一定的目的，比如：</p>
</blockquote>
<ul>
<li>影响数据： 重放添加接口可能会无限添加数据；</li>
<li>数据泄漏： 攻击者可以重复访问敏感数据，导致数据泄漏；</li>
<li>资源耗尽： 重复请求可能导致服务器资源的枯竭，影响正常用户的服务；</li>
<li>身份伪装： 通过重复使用合法用户的身份验证凭据，攻击者可以伪装成合法用户执行操作；</li>
</ul>
<h3 id="如何防止重放"><a href="#如何防止重放" class="headerlink" title="如何防止重放"></a>如何防止重放</h3><p>给每个请求加上不可复制、不可模仿的唯一标识：时间戳+随机数并加密；</p>
<ul>
<li>时间戳<ul>
<li>优点：服务端对请求时间戳进行判断，如超过半分钟，认定为重放攻击，请求无效；</li>
<li>缺点：时间戳无法完全防止重放攻击。未认证系统还是可以在这半分钟的内，通过截获请求、重放请求来调用接口。并且认证双方需要准确的时间同步，同步越好，受攻击的可能性就越小。但当系统很庞大，跨越的区域较广时，要做到精确的时间同步并不是很容易。</li>
</ul>
</li>
<li>随机数<ul>
<li>优点：认证双方不需要时间同步，Redis缓存中如果有使用过的随机数，就认为是重放攻击；</li>
<li>缺点：需要保存所有使用过的随机数，若记录的时间段较长，则保存和查询的开销较大；</li>
</ul>
</li>
<li>时间戳+随机数并加密<ul>
<li>优点：超过半分钟，通过时间戳认定为重放攻击，请求无效；半分钟内，通过Redis存储的随机数认定为重放攻击，请求无效，超过半分钟，释放Redis随机数，避免存储大量数据；</li>
</ul>
</li>
</ul>
<h3 id="具体方案"><a href="#具体方案" class="headerlink" title="具体方案"></a>具体方案</h3><p>大致流程：</p>
<ol>
<li>前端：登录前先请求接口获取服务器时间，与本地时间比对，保存时间差；(这里不直接用前端的本地时间，是因为担心服务器时间与客户端时间存在偏差，前端通过此接口获取时间差并保存；之后所有接口防重放的时间戳都直接通过前端本地时间+校验时间差获取，即：获取服务器时间的接口只需要请求一次)；</li>
<li>前端：根据时间差校正本地时间，用校正后的本地时间拼接上随机数加密(生成的随机数需保证30s内不重复(可为唯一值)，加密使用RSA的公钥)，得到nonce（唯一标识）；</li>
<li>前端：将nonce放入API请求的请求头进行请求；</li>
<li>后端：在GateWay获取到请求头的nonce并解密；</li>
<li>后端：将解密后的时间戳与本地(服务端)时间做对比，若相差不超过30s则认为请求有效，否则认为请求超时（不返回结果）；</li>
<li>后端：若时间戳校验通过，则通过redis判断随机数是否在redis中，若不存在则认为请求有效并把随机数保存到redis中，过期时间设置为30s, 若存在则认为请求无效（不返回结果）；</li>
</ol>
<h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/deReplay.png" alt="nonce"></p>
<h3 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h3><blockquote>
<p>Tips：前端加密传输用到的第三方库：</p>
<ul>
<li>jsencrypt （非对称加密）   </li>
<li>crypto-js（对称加密）</li>
</ul>
</blockquote>
<p>参考文献：<a target="_blank" rel="noopener" href="https://www.jb51.net/javascript/295944dtv.htm">前端利用jsencrypt.js进行RSA加密示例详解</a></p>
<ol>
<li><p>这里使用到了RSA加密，需要后端传给前端公钥(我们公司直接后端给的，没有用接口传递)，前端通过jsencrypt加密；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install jsencrypt </span><br></pre></td></tr></table></figure>
</li>
<li><p>新建utils，例如JSEncrypt.js，封装对数据加密的方法；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JSEncrypt</span> &#125; <span class="keyword">from</span> <span class="string">&quot;jsencrypt&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">passwordEncryption</span>(<span class="params">passwordUser</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> publicKey =<span class="string">&quot;公钥&quot;</span>; <span class="comment">// 从后台获取公钥，这个保存一下，在这里用。</span></span><br><span class="line">    <span class="keyword">let</span> encryptor = <span class="keyword">new</span> <span class="title class_">JSEncrypt</span>(); <span class="comment">// 新建JSEncrypt对象</span></span><br><span class="line">    encryptor.<span class="title function_">setPublicKey</span>(publicKey); <span class="comment">// 设置公钥</span></span><br><span class="line">    <span class="keyword">let</span> passwordEncryp = encryptor.<span class="title function_">encrypt</span>(passwordUser); <span class="comment">// 对数据进行加密</span></span><br><span class="line">    <span class="keyword">return</span> passwordEncryp;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>登录的时候，请求接口获取服务器时间，与本地时间比对，保存时间差到缓存；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">formData</span>.<span class="title function_">validate</span>(<span class="keyword">async</span> (valid) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">identityReplayPrevention</span>(); <span class="comment">// 请求接口,获取服务端的时间;</span></span><br><span class="line">      <span class="keyword">if</span> (res.<span class="property">code</span> == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">/**</span></span><br><span class="line"><span class="comment">           时间差</span></span><br><span class="line"><span class="comment">           这里需要注意:如果时间差=服务器时间戳-本地时间戳,则校正后的时间戳为本地时间戳+时间差;</span></span><br><span class="line"><span class="comment">                       如果时间差=本地时间戳-服务器时间戳,则校正后的时间戳为本地时间戳-时间差;</span></span><br><span class="line"><span class="comment">                       (可以举个例子:本地时间200,服务器时间400...)</span></span><br><span class="line"><span class="comment">          */</span> </span><br><span class="line">        <span class="keyword">const</span> verificationTimeDifference = res.<span class="property">data</span> - <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">        sessionStorage.<span class="title function_">setItem</span>(<span class="string">&quot;verificationTimeDifference&quot;</span>,verificationTimeDifference);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$message</span>.<span class="title function_">warning</span>(res.<span class="property">message</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">// 登录逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建utils，例如getNonce.js，封装校正后的时间戳+随机数加密方法；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; passwordEncryption &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/JSEncrypt.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getNonceVal</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> verificationTimeDifference = <span class="title class_">Number</span>(sessionStorage.<span class="title function_">getItem</span>(<span class="string">&quot;verificationTimeDifference&quot;</span>)); <span class="comment">//获取时间差</span></span><br><span class="line">  <span class="comment">// 由于防重放改为了整个系统,这里随机数为唯一值;</span></span><br><span class="line">  <span class="keyword">const</span> randomNum = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() + <span class="string">&quot;&quot;</span> + <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">30000</span>);<span class="comment">//唯一值</span></span><br><span class="line">  <span class="keyword">const</span> timeNow = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() + verificationTimeDifference;<span class="comment">// 校正后的时间戳</span></span><br><span class="line">  <span class="keyword">const</span> fakeResult = <span class="string">`<span class="subst">$&#123;timeNow&#125;</span>_<span class="subst">$&#123;randomNum&#125;</span>`</span>; <span class="comment">// 校正后的时间戳_随机数</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">passwordEncryption</span>(fakeResult); <span class="comment">// 加密</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在封装的请求拦截中，给每个请求的请求头加上nonce字段，值为：加密(校正后的时间戳_随机数)；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getNonceVal &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/getNonce.js&quot;</span>;</span><br><span class="line"><span class="comment">// 请求拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 发请求前做的一些处理，数据转化，配置请求头，设置token,设置loading等，根据需求去添加</span></span><br><span class="line">    <span class="comment">// config.data = JSON.stringify(config.data) //数据转化,也可以使用qs转换</span></span><br><span class="line">      </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 防重放处理</span></span><br><span class="line"><span class="comment">     * 为了防止防重放的接口噶了,导致防重放功能失效;处理如下:</span></span><br><span class="line"><span class="comment">     * 前端:如果缓存里面没有时间差,就不在请求头上带nonce;</span></span><br><span class="line"><span class="comment">     * 后端:除了获取时间差的接口请求头可以没有nonce,别的接口如果请求头没有nonce字段,就是非法请求;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">const</span> verificationTimeDifference = sessionStorage.<span class="title function_">getItem</span>(<span class="string">&quot;verificationTimeDifference&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(verificationTimeDifference)&#123;</span><br><span class="line">      config.<span class="property">headers</span>.<span class="property">nonce</span> = <span class="title function_">getNonceVal</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...其他处理</span></span><br><span class="line">    <span class="comment">//如有需要：注意使用token的时候需要引入cookie方法或者用本地localStorage等方法，推荐js-cookie</span></span><br><span class="line">    <span class="keyword">const</span> token = sessionStorage.<span class="title function_">getItem</span>(<span class="string">&quot;token&quot;</span>); <span class="comment">//这里取token之前，你肯定需要先拿到token,存一下</span></span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      config.<span class="property">headers</span>.<span class="property">Authorization</span> = <span class="string">&quot;bearer &quot;</span> + token; <span class="comment">//如果要求携带在请求头中</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看每个接口的请求头，是否包含了nonce字段，因为每个接口请求的时间肯定不一样(毫秒级时间戳)，所以每个接口的nonce值都不一样；(即使相同的数据，每次加密结果也不一样)；</p>
</li>
<li><p>通过postman工具，进行抓包重放；(如果还能正常返回数据，后端的锅，去跟后端battle)；</p>
</li>
</ol>
<h2 id="数据完整性校验"><a href="#数据完整性校验" class="headerlink" title="数据完整性校验"></a>数据完整性校验</h2><blockquote>
<p>接口加了防重放就安全了吗？答案是否定的。防重放仅能阻止重放请求，不能保证请求数据不被篡改。比如：我在浏览器请求接口前设置为断网，然后请求该接口，此时我能拿到该请求所需的所有参数，并且这个请求是到达不了服务端的，也就是Redis没有此次请求的随机数，那么我只要在规定的时间间隔内，修改请求数据，发送请求是可以正常返回数据的。</p>
</blockquote>
<h3 id="消息摘要"><a href="#消息摘要" class="headerlink" title="消息摘要"></a>消息摘要</h3><blockquote>
<p>对数据完整性作叫校验，保证请求的数据在传输过程中未被修改；</p>
</blockquote>
<p>参考文献：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/gavincoder/p/13622224.html">深入理解-信息加密&#x2F;信息摘要&#x2F;数字签名</a>，<a target="_blank" rel="noopener" href="https://blog.csdn.net/w1673492580/article/details/113524908">消息摘要、各种加密方式的简要说明</a></p>
<ul>
<li>消息摘要通常采用哈希&#x2F;散列算法生成，比如MD5、SHA、MAC系列，是一种不可逆的单向算法，它可以把任意长度的信息，生成固定长度的摘要，这个摘要是唯一的，任何对输入数据稍作更改都会导致不同的摘要；并且无法通过摘要信息反向解析出原始数据。所以消息摘要一般用来确保数据传输过程中的完整性、不可还原的密码存储；</li>
<li>消息摘要用于生成数据的”指纹”，其算法的主要特征是加密过程不需要密钥，并且经过加密的数据无法被解密；</li>
<li>发送方在传输时，需要将原始数据与摘要信息同时传递给接收方，接收方再对原始数据进行同样的处理得到新的摘要信息，通过对比两个摘要信息是否一样，即可判断数据在传输过程中是否有被修改。 当然，双方需要提前约定好摘要信息的生成规则；</li>
</ul>
<h4 id="具体方案-1"><a href="#具体方案-1" class="headerlink" title="具体方案"></a>具体方案</h4><blockquote>
<p>如果你希望验证整个请求体的完整性，包括请求中的文件数据，通常是通过将整个请求体进行哈希处理（包括文件数据和其他元数据）来生成一个摘要值，然后将该摘要值放在请求头或请求体中一同发送给后端。这样可以确保请求体在传输过程中未被篡改。</p>
</blockquote>
<p>大致流程：</p>
<ol>
<li>前端将请求体的所有内容（包括文件数据和其他元数据）进行哈希处理，生成一个摘要值；</li>
<li>将该摘要值放在请求头中，例如，可以使用自定义请求头；</li>
<li>发送请求至后端，包括请求头和请求体；</li>
<li>后端接收请求后，提取请求头中的摘要值；</li>
<li>后端再次对整个请求体进行哈希处理，生成一个新的摘要值；</li>
<li>后端将前端提供的摘要值与自己生成的摘要值进行比较，以验证请求体的完整性；</li>
</ol>
<ul>
<li>这种方法确保了请求体中的所有内容都被包括在摘要计算中，因此即使请求体中的任何部分被篡改，摘要值也会不同，从而使后端能够检测到篡改；</li>
<li>需要注意的是，这需要前端和后端都遵守相同的摘要算法和相同的计算方法，以便正确验证请求体的完整性。另外，这种方式会增加请求的计算和处理负担，特别是对于大文件的情况；</li>
</ul>
<h4 id="时序图-1"><a href="#时序图-1" class="headerlink" title="时序图"></a>时序图</h4><p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/messageZhaiYao.png" alt="zhaiyao"></p>
<h4 id="基本代码"><a href="#基本代码" class="headerlink" title="基本代码"></a>基本代码</h4><ul>
<li>安装 crypto-js</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install crypto-js</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用：<code>const crytoResult = CryptoJS.SHA256(params).toString(CryptoJS.enc.Hex).toUpperCase();</code></p>
</li>
<li><p>解释：</p>
<ul>
<li><p><code>CryptoJS.SHA256(params)</code>: 这部分使用 CryptoJS 库中的 <code>SHA256</code> 函数来计算输入 <code>params</code> 的 SHA-256 摘要。SHA-256 是一种散列函数，它将输入数据转换为固定长度的散列值，通常为 64 个字符的十六进制字符串。</p>
</li>
<li><p><code>.toString(CryptoJS.enc.Hex)</code>: 这部分将计算得到的 SHA-256 摘要转换为一个十六进制字符串。SHA-256 摘要通常以二进制形式存储，但这里使用 <code>toString</code> 函数将其转换为十六进制表示。</p>
</li>
<li><p><code>.toUpperCase()</code>: 最后，这部分将得到的十六进制字符串的所有字符都转换为大写形式。这是一个常见的做法，以确保摘要的表示方式一致，因为十六进制通常用大写字母表示。</p>
</li>
<li><p>在 CryptoJS 中，<code>CryptoJS.enc.Hex</code> 编码格式用于将数据转换为十六进制字符串或从十六进制字符串解码为原始二进制数据。当使用 <code>toString(CryptoJS.enc.Hex)</code> 时，它会将数据转换为十六进制字符串，而当你使用 <code>parse</code> 方法时，它会将十六进制字符串解码为原始二进制数据。</p>
</li>
<li><p>例如，如果有一个二进制摘要，并想将其表示为十六进制字符串，可以使用 <code>toString(CryptoJS.enc.Hex)</code>。反之，如果有一个十六进制字符串并想将其解码为原始二进制数据，可以使用 <code>CryptoJS.enc.Hex.parse()</code>。</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;getZysf&quot;</span>&gt;</span>获取摘要算法<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> <span class="title class_">CryptoJS</span> <span class="keyword">from</span> <span class="string">&quot;crypto-js/crypto-js&quot;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">const</span> params = <span class="title function_">reactive</span>(&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">name</span>: <span class="string">&quot;fsllala&quot;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">age</span>: <span class="number">18</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">const</span> <span class="title function_">getZysf</span> = (<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="keyword">const</span> crytoResult = <span class="title class_">CryptoJS</span>.<span class="title class_">SHA256</span>(params)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    .<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Hex</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    .<span class="title function_">toUpperCase</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="variable language_">console</span>.<span class="title function_">log</span>(crytoResult); <span class="comment">// 4EA5C508A6566E76240543F8FEB06FD457777BE39549C4016436AFDA65D2330E</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&quot;scss&quot;</span> <span class="attr">scoped</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>看似功能已经实现，但改数据<code>params.age=19</code>之后，发现消息摘要没有变。即：对象内部的属性值发生了改变，但结果却没有改变，这可能是因为 CryptoJS 的 SHA-256 摘要是在对象上执行的浅比较。浅比较意味着它只比较对象的引用而不比较对象内部属性的变化。</p>
</blockquote>
<ul>
<li>解决方法：将数据加密之前通过<code>JSON.stringify</code>转成字符串；</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;getZysf&quot;</span>&gt;</span>获取摘要算法<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>params:&#123;&#123; params &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> <span class="title class_">CryptoJS</span> <span class="keyword">from</span> <span class="string">&quot;crypto-js/crypto-js&quot;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">const</span> params = <span class="title function_">reactive</span>(&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">name</span>: <span class="string">&quot;fsllala&quot;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">age</span>: <span class="number">18</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">const</span> <span class="title function_">getZysf</span> = (<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 如果数据是引用数据类型,CryptoJS只会看地址,不会看值;所以这里转成字符串;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="keyword">const</span> crytoResult = <span class="title class_">CryptoJS</span>.<span class="title class_">SHA256</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(params))</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    .<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Hex</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    .<span class="title function_">toUpperCase</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="variable language_">console</span>.<span class="title function_">log</span>(crytoResult); <span class="comment">// 3B8ECA7F0611E3994AC06B9560B3DD8863006D19D480FB27D8D38044BF48D634</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&quot;scss&quot;</span> <span class="attr">scoped</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h4 id="前端代码-1"><a href="#前端代码-1" class="headerlink" title="前端代码"></a>前端代码</h4><ol>
<li><p>这里和后端约定好：使用SHA256，数据转为字符串加密，加密结果转十六进制且转换为大写形式；摘要放在请求头：X-Digest字段中；</p>
</li>
<li><p>安装所需第三方库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install crypto-js</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建utils，例如Crypto.js，封装对数据摘要的方法；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">CryptoJS</span> <span class="keyword">from</span> <span class="string">&quot;crypto-js/crypto-js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">getCtyptoJS</span> = (<span class="params">params</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> params === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">    params = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(params);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> crytoResult = <span class="title class_">CryptoJS</span>.<span class="title class_">SHA256</span>(params)</span><br><span class="line">    .<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Hex</span>)</span><br><span class="line">    .<span class="title function_">toUpperCase</span>();</span><br><span class="line">  <span class="keyword">return</span> crytoResult;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在封装的请求拦截中，给与后端约定好的接口请求头加上X-Digest字段；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getCtyptoJS &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/Crypto&quot;</span>;</span><br><span class="line"><span class="comment">// 请求拦截器</span></span><br><span class="line">service.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//发请求前做的一些处理，数据转化，配置请求头，设置token,设置loading等，根据需求去添加</span></span><br><span class="line">    <span class="comment">// config.data = JSON.stringify(config.data) //数据转化,也可以使用qs转换</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 信息摘要：</span></span><br><span class="line"><span class="comment">     * 与后端确认问题：</span></span><br><span class="line"><span class="comment">     * 1、get请求需要摘要吗?  params不需要,query需要</span></span><br><span class="line"><span class="comment">     * 2、post请求文件需要摘要吗? 需要</span></span><br><span class="line"><span class="comment">     * 最终:对接的后端说文件信息form-data获取不到,固body请求为application/json和www-form-urlencoded两种,GET请求query进行了摘要;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在请求被发送之前，可以在这里访问请求体数据 (body) 和 URL 参数 (params)</span></span><br><span class="line">    <span class="comment">// console.log(&quot;requUrl:&quot;, config.url);</span></span><br><span class="line">    <span class="comment">// console.log(&quot;body:&quot;, config.data, JSON.stringify(config.data)); // 这里如果是POST的form-data打印为FormData &#123;&#125;,其JSON.stringify(config.data)为 &#x27;&#123;&#125;&#x27;</span></span><br><span class="line">    <span class="comment">// console.log(&quot;query&quot;, config.params);</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">// body摘要(POST/DELETE/PUT)</span></span><br><span class="line">    <span class="keyword">const</span> interPost = config.<span class="property">data</span>;</span><br><span class="line">    <span class="comment">//这里通过JSON.stringify(config.data) !== &quot;&#123;&#125;&quot;,将form-data文件上传进行过滤;</span></span><br><span class="line">    <span class="keyword">if</span> (interPost &amp;&amp; <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(config.<span class="property">data</span>) !== <span class="string">&quot;&#123;&#125;&quot;</span>) &#123;</span><br><span class="line">      config.<span class="property">headers</span>[<span class="string">&quot;X-Digest&quot;</span>] = <span class="title function_">getCtyptoJS</span>(interPost);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// get?之后数据的摘要</span></span><br><span class="line">    <span class="keyword">const</span> interGetQuery = config.<span class="property">params</span>;</span><br><span class="line">    <span class="keyword">if</span> (interGetQuery) &#123;</span><br><span class="line">      config.<span class="property">headers</span>[<span class="string">&quot;X-Digest&quot;</span>] = <span class="title function_">getCtyptoJS</span>(interGetQuery);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 访问文件数据，通常需要使用 FormData 对象来构建请求体</span></span><br><span class="line">    <span class="comment">// if (config.data instanceof FormData) &#123;</span></span><br><span class="line">    <span class="comment">//   const formDataParams = &#123;&#125;;</span></span><br><span class="line">    <span class="comment">//   // 遍历 FormData 对象的键值对</span></span><br><span class="line">    <span class="comment">//   config.data.forEach((value, key) =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     formDataParams[key] = value;</span></span><br><span class="line">    <span class="comment">//     // if (value instanceof File) &#123;</span></span><br><span class="line">    <span class="comment">//     //   console.log(&quot;File:&quot;, key, value);</span></span><br><span class="line">    <span class="comment">//     // &#125;</span></span><br><span class="line">    <span class="comment">//   &#125;);</span></span><br><span class="line">    <span class="comment">//   // console.log(&quot;formDataParams&quot;, formDataParams);</span></span><br><span class="line">    <span class="comment">//   config.headers[&quot;X-Digest&quot;] = getCtyptoJS(formDataParams);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看与后端约定好的接口请求头上，是否包含了X-Digest字段；</p>
</li>
<li><p>通过postman工具，进行抓包，修改数据，请求；(这里如果防重放和数据摘要都做了，可以通过断网的方式”避开”防重放)；</p>
</li>
<li><p>如果出了问题，大概率是前后端摘要的数据不一样导致的摘要值不同。(可能为特殊字符转码问题，数据类型不一致问题等；可以将前后端摘要的数据进行对比，进行问题的排查)；</p>
</li>
<li><p>至此，整个功能已实现。一般来说仅对POST&#x2F;DELETE&#x2F;PUT等这样能够影响到数据的做摘要处理。</p>
</li>
<li><p>其实以上代码仅对一部分接口(body、query)进行了摘要处理，而对于params参数的接口未做处理，例如:<code>delete/:id</code>；可以通过摘要<code>请求数据+接口</code>的方式做更进一步的摘要处理。我们这里没有这样做；(我懒(不是))；</p>
</li>
<li><p>这里说一下，为什么log打印的上传文件为FormData {}，而使用 FormData 对象来构建请求体就能够拿到数据；</p>
<blockquote>
<p>在 JavaScript 中，console.log 可能会以异步方式处理对象的输出，这意味着在某些情况下，当直接使用 console.log(config.data) 时，可能看不到数据。这是因为在异步处理期间，config.data 的值可能已经发生了变化或被修改。这种情况在某些情况下特别适用于 FormData 对象，因为它可以在异步上下文中使用。</p>
<p>通过使用 forEach 方法，实际上迫使 JavaScript 立即处理对象，因此你能够遍历 FormData 对象的键值对并查看其中的数据。这种方法确保了能够在遍历过程中查看正确的数据。</p>
</blockquote>
</li>
</ol>
<h2 id="SourceMap"><a href="#SourceMap" class="headerlink" title="SourceMap"></a>SourceMap</h2><ul>
<li>背景：系统安全功能验证报告中指出：生产环境前端源代码泄露；</li>
<li>前端环境：webpack，vue&#x2F;cli4.5.15，vue2.6、node16.18.0；</li>
<li>现象：跟源代码不一致，但是有八分相像；</li>
</ul>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/sourcemap01.jpg" alt="sourcemap1"></p>
<h3 id="什么是source-map"><a href="#什么是source-map" class="headerlink" title="什么是source map"></a>什么是source map</h3><p>参考文献：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7016510600960278565">一文看懂 webpack 的所有 source map</a> ，<a target="_blank" rel="noopener" href="https://juejin.cn/post/7245536612628971581">什么是SourceMap？webpack devtool超详细解析</a>，<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/XPqt7NsfItlnBndyQ4Pk-g">Webpack 性能优化</a>；</p>
<blockquote>
<p>现代的前端开发总是伴随的各种框架， 在使用这些框架开发的代码需要经过编译才可以在生产环节使用， 编译后就伴随着可读性的降低，也会影响我们的错误调试。 那source map就是为了解决这个问题。</p>
<p>Source map可以理解为一个地图， 通过它可以获知编译后的代码 对应编译前的代码位置。这样当代码遇到异常， 我们就可以通过报错信息定位至准确的位置。 同时在浏览器 sources 也可以查看到源码。</p>
</blockquote>
<p>编译后的代码内只需要包含这样一句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @ sourceMappingURL=map文件路径</span></span><br></pre></td></tr></table></figure>

<p>就可以关联上 source map文件了;</p>
<h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><p>这里对<code>vue.config.js</code>进行了修改；(具体可查阅上方参考文献)；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">lintOnSave</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    生产环境设置nosources-source-map(看不到代码,但是报错能看到报错的代码行号);</span></span><br><span class="line"><span class="comment">    研发环境不做处理;</span></span><br><span class="line"><span class="comment">  */</span> </span><br><span class="line">  <span class="attr">configureWebpack</span>:</span><br><span class="line">    process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&quot;production&quot;</span></span><br><span class="line">      ? &#123;</span><br><span class="line">          <span class="attr">devtool</span>: <span class="string">&quot;nosources-source-map&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      : &#123;&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>修改完之后，生产环境现象如下：</p>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/sourcemap02.png" alt="sourcemap2"></p>
<h2 id="Nginx相关"><a href="#Nginx相关" class="headerlink" title="Nginx相关"></a>Nginx相关</h2><h3 id="TLS低于1-2"><a href="#TLS低于1-2" class="headerlink" title="TLS低于1.2"></a>TLS低于1.2</h3><blockquote>
<p>网站通过mkcert+nginx生成了https站点(<a href="https://fsllala.top/articles/3ef665a6">详见</a>)，虽然页面上显示使用的是TLS1.3，但是第三方检测机构检测出来同时使用了TLS1.0和1.1，此协议同SSL协议一样，较危险，建议升级到TLS1.2及以上；</p>
</blockquote>
<ul>
<li><p>环境与工具：Centos、FinalShell，nmap(开源检测工具)；</p>
</li>
<li><p>安装：<code>sudo yum install nmap</code></p>
</li>
<li><p>查看SSL&#x2F;TLS：<code>nmap --script +ssl-enum-ciphers -p port ip</code></p>
</li>
<li><p>修改nginx：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">3</span>;  <span class="comment"># 只启用TLS1.3协议版本 (window可以在一行写 1.2 1.3;linux需要写两行ssl_protocol TLSv1.2/3)</span></span><br><span class="line">  <span class="comment"># 其他SSL配置项...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="tabs" id="tlschange"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tlschange-1">修改前</button></li><li class="tab"><button type="button" data-href="#tlschange-2">修改后</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tlschange-1"><p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/TLS01.png" alt="nmap1"></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tlschange-2"><p><strong><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/TLS02.png" alt="nmap2"></strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></li>
</ul>
<h3 id="ngnix版本号暴露"><a href="#ngnix版本号暴露" class="headerlink" title="ngnix版本号暴露"></a>ngnix版本号暴露</h3><p>修改nginx</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="comment"># 其他配置...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="iframe可以嵌套"><a href="#iframe可以嵌套" class="headerlink" title="iframe可以嵌套"></a>iframe可以嵌套</h3><blockquote>
<p>期望：通过iframe不能嵌套该网站；</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> yourdomain.com;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">add_header</span> X-Frame-Options <span class="string">&quot;DENY&quot;</span>; <span class="comment"># 加上介个</span></span><br><span class="line">        <span class="comment"># 其他服务器配置...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://fsllala.top">Forward</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://fsllala.top/articles/fa0f2f9c.html">https://fsllala.top/articles/fa0f2f9c.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://fsllala.top" target="_blank">Forward の Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a></div><div class="post_share"><div class="social-share" data-image="https://cover.fsllala.top/default_cover_57.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/articles/5157567c.html"><img class="prev-cover" src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_45.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Koa2实战</div></div></a></div><div class="next-post pull-right"><a href="/articles/b9f20a20.html"><img class="next-cover" src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_64.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">webpack</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="author_top is-center"><div class="avatar-img"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/1656236729350avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Forward</div><div class="author-info__description">记录一些知识点🥝</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">55</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">51</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/fsllala"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/fsllala" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://gitee.com/fsllala" target="_blank" title="Gitee"><i class="fa-brands fa-git-square"></i></a><a class="social-icon" href="mailto:1779318132@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"></div><div id="welcome-info"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E9%87%8D%E6%94%BE"><span class="toc-number">2.</span> <span class="toc-text">接口重放</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%87%8D%E6%94%BE"><span class="toc-number">2.1.</span> <span class="toc-text">什么是重放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E9%87%8D%E6%94%BE"><span class="toc-number">2.2.</span> <span class="toc-text">如何防止重放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%96%B9%E6%A1%88"><span class="toc-number">2.3.</span> <span class="toc-text">具体方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E5%BA%8F%E5%9B%BE"><span class="toc-number">2.4.</span> <span class="toc-text">时序图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-number">2.5.</span> <span class="toc-text">前端代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E6%80%A7%E6%A0%A1%E9%AA%8C"><span class="toc-number">3.</span> <span class="toc-text">数据完整性校验</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%91%98%E8%A6%81"><span class="toc-number">3.1.</span> <span class="toc-text">消息摘要</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%96%B9%E6%A1%88-1"><span class="toc-number">3.1.1.</span> <span class="toc-text">具体方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E5%BA%8F%E5%9B%BE-1"><span class="toc-number">3.1.2.</span> <span class="toc-text">时序图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%A3%E7%A0%81"><span class="toc-number">3.1.3.</span> <span class="toc-text">基本代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81-1"><span class="toc-number">3.1.4.</span> <span class="toc-text">前端代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SourceMap"><span class="toc-number">4.</span> <span class="toc-text">SourceMap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFsource-map"><span class="toc-number">4.1.</span> <span class="toc-text">什么是source map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9"><span class="toc-number">4.2.</span> <span class="toc-text">修改</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%9B%B8%E5%85%B3"><span class="toc-number">5.</span> <span class="toc-text">Nginx相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TLS%E4%BD%8E%E4%BA%8E1-2"><span class="toc-number">5.1.</span> <span class="toc-text">TLS低于1.2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ngnix%E7%89%88%E6%9C%AC%E5%8F%B7%E6%9A%B4%E9%9C%B2"><span class="toc-number">5.2.</span> <span class="toc-text">ngnix版本号暴露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iframe%E5%8F%AF%E4%BB%A5%E5%B5%8C%E5%A5%97"><span class="toc-number">5.3.</span> <span class="toc-text">iframe可以嵌套</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/articles/b9f20a20.html" title="webpack"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_64.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="webpack"/></a><div class="content"><a class="title" href="/articles/b9f20a20.html" title="webpack">webpack</a><time datetime="2024-01-03T12:15:07.000Z" title="发表于 2024-01-03 20:15:07">2024-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/fa0f2f9c.html" title="网络安全修改"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_57.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="网络安全修改"/></a><div class="content"><a class="title" href="/articles/fa0f2f9c.html" title="网络安全修改">网络安全修改</a><time datetime="2023-11-09T10:23:04.000Z" title="发表于 2023-11-09 18:23:04">2023-11-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/5157567c.html" title="Koa2实战"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_45.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koa2实战"/></a><div class="content"><a class="title" href="/articles/5157567c.html" title="Koa2实战">Koa2实战</a><time datetime="2023-10-28T02:23:04.000Z" title="发表于 2023-10-28 10:23:04">2023-10-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/65b69107.html" title="Nginx"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_43.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx"/></a><div class="content"><a class="title" href="/articles/65b69107.html" title="Nginx">Nginx</a><time datetime="2023-08-24T02:00:03.000Z" title="发表于 2023-08-24 10:00:03">2023-08-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/3ef665a6.html" title="https"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_40.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="https"/></a><div class="content"><a class="title" href="/articles/3ef665a6.html" title="https">https</a><time datetime="2023-04-26T01:55:37.000Z" title="发表于 2023-04-26 09:55:37">2023-04-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Forward</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0</span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://netlity.fsllala.top/js/fancybox.umd.min.js"></script><script src="https://netlity.fsllala.top/js/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://netlity.fsllala.top/js/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.fsllala.top',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.fsllala.top',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="/js/jquery.min.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/cursor.js"></script><script defer data-pjax src="/js/cat.js"></script><script defer data-pjax src="/js/readPercent.js"></script><script async data-pjax src="/js/txMap.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://netlity.fsllala.top/js/canvas-nest.min.js"></script><script src="https://netlity.fsllala.top/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://netlity.fsllala.top/js/click-heart.min.js" async="async" mobile="false"></script><script src="https://netlity.fsllala.top/js/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html><div id="web_bg"></div>