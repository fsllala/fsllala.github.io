<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Koa2实战 | Forward の Blog</title><meta name="author" content="Forward"><meta name="copyright" content="Forward"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="koa2项目实战本文所有代码已上传：github 项目的搭建目录结构的划分 按照功能模块划分：例如：控制器(controller)的放在一起；操作数据库(service)的放在一起…… 按照业务模块划分：一个完整的小功能放在一起；   本文将用功能模块划分  1234567-src    -main"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://fsllala.top/articles/5157567c"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://jsd.012700.xyz/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://netlify.fsllala.top/css/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Koa2实战',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-05-14 23:30:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/onePic.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/wind.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/cursor.css"><link rel="stylesheet" href="/css/cat.css"><link rel="stylesheet" href="/css/readPercent.css"><link rel="stylesheet" href="/css/txMap.css"><link rel="stylesheet" href="/css/avator.css"><div id="myscoll"></div><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/1656236729350avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">49</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">55</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cover.fsllala.top/default_cover_45.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Forward の Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Koa2实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-28T02:23:04.000Z" title="发表于 2023-10-28 10:23:04">2023-10-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-14T15:30:39.695Z" title="更新于 2025-05-14 23:30:39">2025-05-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/NodeJs/">NodeJs</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/NodeJs/Koa2/">Koa2</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>63分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Koa2实战"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="koa2项目实战"><a href="#koa2项目实战" class="headerlink" title="koa2项目实战"></a>koa2项目实战</h1><p>本文所有代码已上传：<a target="_blank" rel="noopener" href="https://github.com/fsllala/koa2">github</a></p>
<h2 id="项目的搭建"><a href="#项目的搭建" class="headerlink" title="项目的搭建"></a>项目的搭建</h2><h3 id="目录结构的划分"><a href="#目录结构的划分" class="headerlink" title="目录结构的划分"></a>目录结构的划分</h3><ul>
<li>按照功能模块划分：例如：控制器(controller)的放在一起；操作数据库(service)的放在一起……</li>
<li>按照业务模块划分：一个完整的小功能放在一起；</li>
</ul>
<blockquote>
<p>本文将用<code>功能模块划分</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-src</span><br><span class="line">    -main.<span class="property">js</span>  <span class="comment">//入口文件</span></span><br><span class="line">    -app <span class="comment">//全局文件夹</span></span><br><span class="line">    -controller <span class="comment">//所有的控制器</span></span><br><span class="line">    -service <span class="comment">//数据库操作相关</span></span><br><span class="line">    -router <span class="comment">//路由相关</span></span><br><span class="line">    -utils <span class="comment">//工具</span></span><br></pre></td></tr></table></figure>

<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在src目录下</span></span><br><span class="line">npm init -y</span><br><span class="line">npm i koa</span><br><span class="line">npm i nodemon -D    <span class="comment">//-D为开发依赖</span></span><br></pre></td></tr></table></figure>

<h4 id="设置快捷启动"><a href="#设置快捷启动" class="headerlink" title="设置快捷启动"></a>设置快捷启动</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在package.json 配置</span></span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;start&quot;</span>: <span class="string">&quot;nodemon ./src/main.js&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// 之后可以直接通过 npm run start 方式启动项目,不需要找目录结构了</span></span><br></pre></td></tr></table></figure>

<h4 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h4><blockquote>
<p><code>main.js</code>键入如下代码：使用<code>nodemon main.js</code>即可启动服务；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;服务器启动成功~~&quot;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>但是入口文件中，代码越简洁越好，现在所有<code>app</code>的操作都在入口文件，不是很妥；</p>
</blockquote>
<h4 id="入口文件拆分"><a href="#入口文件拆分" class="headerlink" title="入口文件拆分"></a>入口文件拆分</h4><blockquote>
<p>在<code>app</code>文件中，新建<code>index.js</code>，用来放<code>app</code>的相关操作，然后在<strong>入口文件</strong>中，将其引入即可；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app文件下的 index.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=app;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//入口文件 main.js</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">&quot;./app/index.js&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;服务器启动成功~~&quot;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><blockquote>
<p>端口号是直接在代码中写死的，不妥，需要<strong>抽离</strong>出来，写在<strong>配置文件</strong>中</p>
<p>在<strong>根目录</strong>（与<code>package.json</code>同级目录）下新建一个<code>.env</code>（environment）做<strong>配置文件</strong>用来存放所有抽离出来的<strong>环境变量</strong>，比如端口号；那么<strong>入口文件</strong>之如何读取到<code>.env</code>文件呢？</p>
</blockquote>
<ul>
<li><p>在<code>.env</code>配置文件中，写入<code>APP_PORT=3000</code></p>
</li>
<li><p>下载<code>dotenv</code>插件：</p>
<p><code>npm i dotenv</code></p>
<ul>
<li>因为<code>.env</code>文件是需要全局加载的，所以在<code>app</code>目录下新建<code>config.js</code>文件</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  app/config.js</span></span><br><span class="line"><span class="keyword">const</span> dotenv = <span class="built_in">require</span>(<span class="string">&quot;dotenv&quot;</span>);</span><br><span class="line">dotenv.<span class="title function_">config</span>(); <span class="comment">//将.env中的变量挂载到process.env中</span></span><br><span class="line"><span class="comment">// console.log(process.env.APP_PORT);</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="variable constant_">APP_PORT</span></span><br><span class="line">&#125; = process.<span class="property">env</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> app= <span class="built_in">require</span>(<span class="string">&quot;./app/index.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&quot;./app/config.js&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(config.<span class="property">APP_PORT</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server is running port is <span class="subst">$&#123;config.APP_PORT&#125;</span>`</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="用户注册接口"><a href="#用户注册接口" class="headerlink" title="用户注册接口"></a>用户注册接口</h2><blockquote>
<p>首先考虑： 请求路径与中间件处理的映射，但是<code>koa</code>不支持<code>app.post</code>等写法，只能用<code>app.use</code>，需要手动处理；所以只能借助路由第三方库<code>koa-router</code></p>
</blockquote>
<ul>
<li>下载路由第三方库：<code>npm i koa-router</code>；</li>
<li>查询数据需要获取到用户传递的参数，下载第三方库<code>npm i koa-bodyparser</code></li>
<li>使用<code>postman</code>进行测试；</li>
</ul>
<h3 id="架构基础写法"><a href="#架构基础写法" class="headerlink" title="架构基础写法"></a>架构基础写法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app文件下的 index.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser= <span class="built_in">require</span>(<span class="string">&quot;koa-bodyparser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>:<span class="string">&quot;/users&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">userRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,<span class="function">(<span class="params">ctx,next</span>)=&gt;</span>&#123;</span><br><span class="line">    ctx.<span class="property">body</span>=<span class="string">&quot;创建用户成功~&quot;</span>;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册body-parser</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line"><span class="comment">// 注册路由</span></span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=app;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>所有的路由相关的接口如果都写在 <code>app文件下的 index.js</code>里面的话，代码会显得很臃肿，而且也不容易进行后期维护；</p>
</blockquote>
<h3 id="架构进阶写法"><a href="#架构进阶写法" class="headerlink" title="架构进阶写法"></a>架构进阶写法</h3><h4 id="路由拆分"><a href="#路由拆分" class="headerlink" title="路由拆分"></a>路由拆分</h4><blockquote>
<p>在<code>router</code>文件夹下新建<code>user.router.js</code>，用来存储用户的路由信息；只负责注册接口，中间件处理逻辑不写在这里(见下文)；</p>
<p>将<code>router</code>路由抽离出去；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.router.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>:<span class="string">&quot;/users&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">userRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,<span class="function">(<span class="params">ctx,next</span>)=&gt;</span>&#123;</span><br><span class="line">    ctx.<span class="property">body</span>=<span class="string">&quot;创建用户成功~&quot;</span>;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = userRouter;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/index.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser= <span class="built_in">require</span>(<span class="string">&quot;koa-bodyparser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&quot;../router/user.router.js&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册body-parser</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line"><span class="comment">// 注册路由</span></span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=app;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其实<strong>接口请求的中间件的逻辑</strong>(见下面代码)也是很多的，所以也需求抽取；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接口请求的中间件的逻辑</span></span><br><span class="line">userRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,<span class="function">(<span class="params">ctx,next</span>)=&gt;</span>&#123;</span><br><span class="line">    ctx.<span class="property">body</span>=<span class="string">&quot;创建用户成功~&quot;</span>;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//中的</span></span><br><span class="line">(ctx,next)=&gt;&#123;</span><br><span class="line">    ctx.<span class="property">body</span>=<span class="string">&quot;创建用户成功~&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//只负责注册接口,中间件处理逻辑不写在这里</span></span><br><span class="line">userRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,具体的处理逻辑);</span><br></pre></td></tr></table></figure>

<h4 id="路由中间件拆分"><a href="#路由中间件拆分" class="headerlink" title="路由中间件拆分"></a>路由中间件拆分</h4><blockquote>
<p>在<code>controller</code>文件夹新建<code>user.controller.js</code>，用来存放 中间件处理逻辑；</p>
<p>将路由中间件抽离出去；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  controller/user.controller.js</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="comment">// 因为操作数据库是异步操作的,所以直接用 async 函数; async函数为对象的方法,下面直接module导出了一个对象;</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx,next</span>)&#123;</span><br><span class="line">        <span class="comment">// 获取用户请求传递的参数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询数据</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回数据</span></span><br><span class="line">        ctx.<span class="property">body</span>=<span class="string">&quot;controller success~&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>= <span class="keyword">new</span> <span class="title class_">UserController</span>(); <span class="comment">//导出的是一个对象(类的实例)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.router.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="comment">// user.controller.js直接导出了一个实例对象,调用其方法;</span></span><br><span class="line"><span class="keyword">const</span> &#123;create&#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/user.controller.js&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>:<span class="string">&quot;/users&quot;</span>&#125;);</span><br><span class="line">userRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,create)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = userRouter;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不难发现，即使抽离出来了中间件，<code>user.controller.js</code>异步方法里需要进行<strong>获取用户请求传递的参数，查询数据，返回数据</strong>的操作，依旧很繁琐；</p>
<p>故将<code>查询数据</code>的代码逻辑抽取出来，放到<code>service</code>的文件里；</p>
</blockquote>
<h4 id="路由中间件操作数据库拆分"><a href="#路由中间件操作数据库拆分" class="headerlink" title="路由中间件操作数据库拆分"></a>路由中间件操作数据库拆分</h4><blockquote>
<p>在<code>service</code>文件夹新建<code>user.service.js</code>，用来存放 查询数据 逻辑；</p>
<p>将操作数据库的逻辑抽离出去；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  service/user.service.js</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">user</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;user.controller传入的实参为&quot;</span>, user);</span><br><span class="line">        <span class="comment">// 将user存储到数据库中</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;service success&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controller/user.controller.js</span></span><br><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&quot;../service/user.service.js&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="comment">// 因为操作数据库是异步操作的,所以直接用 async 函数; async函数为对象的方法,下面直接module导出了一个对象;</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx,next</span>)&#123;</span><br><span class="line">        <span class="comment">// 获取用户请求传递的参数</span></span><br><span class="line">        <span class="keyword">const</span> user = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">        <span class="comment">// 查询数据</span></span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">create</span>(user);</span><br><span class="line">        <span class="comment">// 返回数据</span></span><br><span class="line">        ctx.<span class="property">body</span>= result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>= <span class="keyword">new</span> <span class="title class_">UserController</span>(); <span class="comment">//导出的是一个对象(类的实例)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.router.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="comment">// user.controller.js直接导出了一个实例对象,调用其方法;</span></span><br><span class="line"><span class="keyword">const</span> &#123;create&#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/user.controller.js&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>:<span class="string">&quot;/users&quot;</span>&#125;);</span><br><span class="line">userRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,create)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = userRouter;</span><br></pre></td></tr></table></figure>

<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/userSign11673224991635.png" alt="userSignin1"></p>
<blockquote>
<p>至此，架构已经大致划分完毕：一个接口划分了三层：<strong>router层、controller层、service层</strong>；</p>
</blockquote>
<h3 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h3><h4 id="安装依赖-1"><a href="#安装依赖-1" class="headerlink" title="安装依赖"></a>安装依赖</h4><ul>
<li>安装<code>mysql2</code>： <code>npm i mysql2</code>；</li>
</ul>
<h4 id="创建连接"><a href="#创建连接" class="headerlink" title="创建连接"></a>创建连接</h4><ul>
<li>创建<strong>连接池</strong>：<code>app</code>文件夹下新建<code>database.js</code>；</li>
</ul>
<blockquote>
<p>连接数据库的一些变量也属于<strong>配置文件</strong>，需要写到配置文件中；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .env</span></span><br><span class="line"><span class="variable constant_">APP_PORT</span>=<span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="variable constant_">MYSQL_HOST</span>=localhost</span><br><span class="line"><span class="variable constant_">MYSQL_PORT</span>=<span class="number">3306</span></span><br><span class="line"><span class="variable constant_">MYSQL_DATABASE</span>=nodeHub</span><br><span class="line"><span class="variable constant_">MYSQL_USER</span>=root</span><br><span class="line"><span class="variable constant_">MYSQL_PASSWORD</span>=<span class="number">123456</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  app/config.js</span></span><br><span class="line"><span class="keyword">const</span> dotenv = <span class="built_in">require</span>(<span class="string">&quot;dotenv&quot;</span>);</span><br><span class="line">dotenv.<span class="title function_">config</span>(); <span class="comment">//将.env中的变量挂载到process.env中</span></span><br><span class="line"><span class="comment">// console.log(process.env.APP_PORT);</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="variable constant_">APP_PORT</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PORT</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_DATABASE</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_USER</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PASSWORD</span>,</span><br><span class="line"></span><br><span class="line">&#125; = process.<span class="property">env</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/database.js</span></span><br><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&quot;mysql2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&quot;./config.js&quot;</span>);</span><br><span class="line"><span class="comment">// 1.创建连接池</span></span><br><span class="line"><span class="keyword">const</span> connectionPool = mysql.<span class="title function_">createPool</span>(&#123;</span><br><span class="line">  <span class="attr">host</span>: config.<span class="property">MYSQL_HOST</span>,</span><br><span class="line">  <span class="attr">port</span>: config.<span class="property">MYSQL_PORT</span>,</span><br><span class="line">  <span class="attr">database</span>: config.<span class="property">MYSQL_DATABASE</span>,</span><br><span class="line">  <span class="attr">user</span>: config.<span class="property">MYSQL_USER</span>,</span><br><span class="line">  <span class="attr">password</span>: config.<span class="property">MYSQL_PASSWORD</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否连接成功</span></span><br><span class="line">connectionPool.<span class="title function_">getConnection</span>(<span class="function">(<span class="params">err, connection</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取连接失败&quot;</span>, err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  connection.<span class="title function_">connect</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;数据库交互失败&quot;</span> + err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;数据库连接成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// connections有promise()方法,可以直接调用;</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = connectionPool.<span class="title function_">promise</span>();</span><br></pre></td></tr></table></figure>

<h4 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  service/user.service.js</span></span><br><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">user</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;name,password&#125; = user;</span><br><span class="line">        <span class="keyword">const</span> statement = <span class="string">`INSERT INTO users(name,password) VALUES(?,?)`</span>;</span><br><span class="line">        <span class="comment">// database.js 导出的是connections.promise();</span></span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[name,password]);</span><br><span class="line">        <span class="comment">// 将user存储到数据库中</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controller/user.controller.js</span></span><br><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&quot;../service/user.service.js&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="comment">// 因为操作数据库是异步操作的,所以直接用 async 函数; async函数为对象的方法,下面直接module导出了一个对象;</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx,next</span>)&#123;</span><br><span class="line">        <span class="comment">// 获取用户请求传递的参数</span></span><br><span class="line">        <span class="keyword">const</span> user = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">        <span class="comment">// 查询数据</span></span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">create</span>(user);</span><br><span class="line">        <span class="comment">// 返回数据</span></span><br><span class="line">        ctx.<span class="property">body</span>= result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>= <span class="keyword">new</span> <span class="title class_">UserController</span>(); <span class="comment">//导出的是一个对象(类的实例)</span></span><br></pre></td></tr></table></figure>

<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/userSign21673225049264.png" alt="userSign2"></p>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/database11673225109224.png" alt="database1"></p>
<blockquote>
<p>以上代码基本实现了用户注册的逻辑，但是如果用户没有传参，或者传入的参数不对，没有做处理；即没有做错误处理；</p>
</blockquote>
<h4 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h4><blockquote>
<p>那错误处理要写在什么地方呢？答案是以中间件的形式写在路由router中，并且在插入数据库中间件之前；</p>
<p>PS：Koa的router路由可以连续注册中间件,验证的中间件写在操作数据库的中间件之前就可以了；</p>
</blockquote>
<ul>
<li>在根目录(<code>package.json</code>同级)下新建<code>middleware</code>文件夹，用来存放中间件；</li>
<li>在<code>middleware</code>文件夹下新建<code>user.middleware.js</code>用来存放验证用户的中间件函数；</li>
<li>中间件为一个个单独的函数，比类使用起来会更灵活一点；所以这里不使用类；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  middleware/user.middleware.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * next之后才会匹配下一个符合条件的中间件；</span></span><br><span class="line"><span class="comment">     * koa的next返回的是个promise;</span></span><br><span class="line"><span class="comment">     * 因为下个中间件有异步操作,所以这里需要加await;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    verifyUser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/user.router.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="comment">// user.controller.js直接导出了一个实例对象,调用其方法;</span></span><br><span class="line"><span class="keyword">const</span> &#123;create&#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/user.controller.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间件</span></span><br><span class="line"><span class="keyword">const</span> &#123;verifyUser&#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/user.middleware.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>:<span class="string">&quot;/users&quot;</span>&#125;);</span><br><span class="line">userRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,verifyUser,create);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = userRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>middleware/user.middleware.js</code>添加逻辑处理</li>
</ul>
<blockquote>
<p>在<code>middleware/user.middleware.js</code>中将错误弹出去；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// middleware/user.middleware.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 获取用户名密码</span></span><br><span class="line">    <span class="keyword">const</span> &#123;name,password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 判断用户名密码不能为空</span></span><br><span class="line">    <span class="keyword">if</span>(!name||!password)&#123;</span><br><span class="line">        <span class="keyword">const</span> userError = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;用户名或密码不能为空&quot;</span>);</span><br><span class="line">        <span class="comment">// return 结束当前函数执行</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,userError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 查看用户是否已经注册(未写)    </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    verifyUser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在<code>app/index.js</code>监听错误</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser= <span class="built_in">require</span>(<span class="string">&quot;koa-bodyparser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&quot;../router/user.router.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> errorHandler = <span class="built_in">require</span>(<span class="string">&quot;./errorHandler.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册body-parser</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line"><span class="comment">// 注册路由</span></span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听错误</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>,errorHandler);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=app;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在<code>app</code>文件夹下新建了一个<code>errorHandler.js</code>来做错误处理；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">errorHandler</span> = (<span class="params">error,ctx</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">//通过 message接收传过来的错误</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error.<span class="property">message</span>);</span><br><span class="line"></span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&quot;发生了错误&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = errorHandler;</span><br></pre></td></tr></table></figure>

<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/userSign31673225167528.png" alt="userSign3"></p>
<blockquote>
<p>但是错误提示语句有很多，最好<code>new Error(xx)</code>里放的是变量，到时候改一个就好了；</p>
</blockquote>
<ul>
<li>在根目录(<code>packagejson</code>同级目录)下新建<code>constants</code>文件夹，里面在新建<code>error-types.js</code>用来存放错误常量；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// constants/error-types.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span> = <span class="string">&quot;name_or_password_is_required&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=&#123;</span><br><span class="line">    <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// middleware/user.middleware.js</span></span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span>&#125; = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 获取用户名密码</span></span><br><span class="line">    <span class="keyword">const</span> &#123;name,password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 判断用户名密码不能为空</span></span><br><span class="line">    <span class="keyword">if</span>(!name||!password)&#123;</span><br><span class="line">        <span class="keyword">const</span> userError = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span>);</span><br><span class="line">        <span class="comment">// return 结束当前函数执行</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,userError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 查看用户是否已经注册(未写)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    verifyUser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/errorHandler.js</span></span><br><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">errorHandler</span> = (<span class="params">error, ctx</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// console.log(error.message);</span></span><br><span class="line">    <span class="keyword">let</span> status, message;</span><br><span class="line">    <span class="keyword">switch</span> (error.<span class="property">message</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> errorType.<span class="property">NAME_OR_PASSWORD_IS_REQUIRED</span>:</span><br><span class="line">            status = <span class="number">400</span>; <span class="comment">//Bad Request</span></span><br><span class="line">            message = <span class="string">&quot;用户名或密码不能为空&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            status = <span class="number">404</span>;</span><br><span class="line">            message = <span class="string">&quot;发生错误了~&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.<span class="property">status</span> = status;</span><br><span class="line">    ctx.<span class="property">body</span> = message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = errorHandler;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看用户是否已经注册的逻辑还没写，即查看用户是否存在；需要查询数据库；</p>
</blockquote>
<h4 id="查看用户是否已经注册"><a href="#查看用户是否已经注册" class="headerlink" title="查看用户是否已经注册"></a>查看用户是否已经注册</h4><blockquote>
<p><code>service/user.service</code>查看数据库</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service/user.service</span></span><br><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">user</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;name,password&#125; = user;</span><br><span class="line">        <span class="keyword">const</span> statement = <span class="string">`INSERT INTO users(name,password) VALUES(?,?)`</span>;</span><br><span class="line">        <span class="comment">// database.js 导出的是connections.promise();</span></span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[name,password]);</span><br><span class="line">        <span class="comment">// 将user存储到数据库中</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">getUserByName</span>(<span class="params">name</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM users WHERE name=?`</span>;</span><br><span class="line">        <span class="comment">// database.js 导出的是connections.promise();</span></span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[name]);</span><br><span class="line">        <span class="keyword">return</span> result[<span class="number">0</span>];  <span class="comment">//返回result的话,又有很多其他信息,只有0才是我们想要的</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>middleware/user.middleware</code>下调用查看数据库的方法；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// middleware/user.middleware</span></span><br><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;getUserByName&#125; = <span class="built_in">require</span>(<span class="string">&quot;../service/user.service.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 获取用户名密码</span></span><br><span class="line">    <span class="keyword">const</span> &#123;name,password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断用户名密码不能为空</span></span><br><span class="line">    <span class="keyword">if</span>(!name||!password)&#123;</span><br><span class="line">        <span class="keyword">const</span> userError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NAME_OR_PASSWORD_IS_REQUIRED</span>);</span><br><span class="line">        <span class="comment">// return 结束当前函数执行</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,userError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断用户不能重复</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getUserByName</span>(name);</span><br><span class="line">    <span class="comment">// console.log(result); </span></span><br><span class="line">    <span class="keyword">if</span>(result.<span class="property">length</span>&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> userError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">USER_IS_EXIT</span>);</span><br><span class="line">        <span class="comment">// return 结束当前函数执行</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,userError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    verifyUser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>constants/error-types</code>下新添加错误变量</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// constants/error-types</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span> = <span class="string">&quot;name_or_password_is_required&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">USER_IS_EXIT</span>=<span class="string">&quot;user_is_exit&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=&#123;</span><br><span class="line">    <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span>,</span><br><span class="line">    <span class="variable constant_">USER_IS_EXIT</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>app/errorHandler.js</code>对新添加的变量做 错误处理；</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/errorHandler.js</span></span><br><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">errorHandler</span> = (<span class="params">error, ctx</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// console.log(error.message);</span></span><br><span class="line">    <span class="keyword">let</span> status, message;</span><br><span class="line">    <span class="keyword">switch</span> (error.<span class="property">message</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> errorType.<span class="property">NAME_OR_PASSWORD_IS_REQUIRED</span>:</span><br><span class="line">            status = <span class="number">400</span>; <span class="comment">//Bad Request</span></span><br><span class="line">            message = <span class="string">&quot;用户名或密码不能为空&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> errorType.<span class="property">USER_IS_EXIT</span>:</span><br><span class="line">            status = <span class="number">409</span>; <span class="comment">//conflict</span></span><br><span class="line">            message = <span class="string">&quot;用户名已存在~&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            status = <span class="number">404</span>;</span><br><span class="line">            message = <span class="string">&quot;发生错误了~&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.<span class="property">status</span> = status;</span><br><span class="line">    ctx.<span class="property">body</span> = message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = errorHandler;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此时，数据库保存的密码是明文的，不安全，需要进行加密处理，这里采用中间件进行密码的加密；</p>
</blockquote>
<h4 id="密码加密"><a href="#密码加密" class="headerlink" title="密码加密"></a>密码加密</h4><blockquote>
<p>新建一个中间件，在 验证用户是否注册 和 插入 之间进行密码的加密；</p>
</blockquote>
<ul>
<li><code>nodejs</code>中自带了 <code>ctypto</code>库，使用这个进行加密，但是加密的方法还需要我们自己写，不是直接调；在<code>utils</code>文件夹新建<code>password-handle</code>封装加密方法；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nodejs中自带了 ctypto库，使用这个进行加密</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">md5Password</span> = (<span class="params">password</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// crypto.createHash(&#x27;加密方式&#x27;)</span></span><br><span class="line">  <span class="keyword">const</span> md5 = crypto.<span class="title function_">createHash</span>(<span class="string">&quot;md5&quot;</span>); <span class="comment">//返回是是一个对象</span></span><br><span class="line">  <span class="comment">// md5.update(加密的数据).digest()==&gt;获取二进制加密的Buffer</span></span><br><span class="line">  <span class="comment">// 进postman测试,md5.update(加密的数据)这个数据必须是string,不能为number;</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> result = md5.<span class="title function_">update</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(password)).<span class="title function_">digest</span>(<span class="string">&quot;hex&quot;</span>); <span class="comment">//获取16进制加密的字符串</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = md5Password;</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>middleware</code>的<code>user.middleware</code>下封装一个处理密码加密的中间件；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;getUserByName&#125; = <span class="built_in">require</span>(<span class="string">&quot;../service/user.service.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> md5Password = <span class="built_in">require</span>(<span class="string">&quot;../utils/password-handle.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 获取用户名密码</span></span><br><span class="line">    <span class="keyword">const</span> &#123;name,password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断用户名密码不能为空</span></span><br><span class="line">    <span class="keyword">if</span>(!name||!password)&#123;</span><br><span class="line">        <span class="keyword">const</span> userError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NAME_OR_PASSWORD_IS_REQUIRED</span>);</span><br><span class="line">        <span class="comment">// return 结束当前函数执行</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,userError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断用户不能重复</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getUserByName</span>(name);</span><br><span class="line">    <span class="comment">// console.log(result); </span></span><br><span class="line">    <span class="keyword">if</span>(result.<span class="property">length</span>&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> userError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">USER_IS_EXIT</span>);</span><br><span class="line">        <span class="comment">// return 结束当前函数执行</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,userError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 密码加密</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handlePassword</span> = <span class="keyword">async</span> (<span class="params">ctx,next</span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>; <span class="comment">//获取到未加密的</span></span><br><span class="line">    ctx.<span class="property">request</span>.<span class="property">body</span>.<span class="property">password</span>= <span class="title function_">md5Password</span>(password); <span class="comment">//将ctx.body上的密码进行加密,然后插入到数据库</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    verifyUser,</span><br><span class="line">    handlePassword,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>router</code>下的<code>user.router.js</code>中进行密码加密中间件的导入与使用；、</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="comment">// user.controller.js直接导出了一个实例对象,调用其方法;</span></span><br><span class="line"><span class="keyword">const</span> &#123;create&#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/user.controller.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间件</span></span><br><span class="line"><span class="keyword">const</span> &#123;verifyUser,handlePassword&#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/user.middleware.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>:<span class="string">&quot;/users&quot;</span>&#125;);</span><br><span class="line">userRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,verifyUser,handlePassword,create);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = userRouter;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注！！！这里在<code>postman</code>测试的时候,密码为数字的时候，会报错。可能是<code>postman</code>的原因，key和value都需要双引号包裹；</p>
</blockquote>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/userSing41673225214071.png" alt="userSing4"></p>
<h2 id="用户登录接口"><a href="#用户登录接口" class="headerlink" title="用户登录接口"></a>用户登录接口</h2><blockquote>
<p>写接口的思想是：一开始没有任何限制，然后一点点的往里面添加中间件，来进行限制。这样才好写，而不是一下子就能想那么多；</p>
</blockquote>
<h3 id="登录逻辑结构搭建"><a href="#登录逻辑结构搭建" class="headerlink" title="登录逻辑结构搭建"></a>登录逻辑结构搭建</h3><ul>
<li><code>router</code>文件夹下新建<code>auth.router.js</code>，用来存放登录的路由逻辑；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;login&#125; =<span class="built_in">require</span>(<span class="string">&quot;../controller/auth.controller.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> authRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>:<span class="string">&quot;/login&quot;</span>&#125;);</span><br><span class="line">authRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,login);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=authRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下新建<code>auth.controller.js</code>，用来存放中间件的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AuthController</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;name&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">`欢迎<span class="subst">$&#123;name&#125;</span>回来~`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">AuthController</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>app</code>文件夹下的<code>index.js</code>中，将路由进行引入与注册；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser= <span class="built_in">require</span>(<span class="string">&quot;koa-bodyparser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&quot;../router/user.router.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> authRouter = <span class="built_in">require</span>(<span class="string">&quot;../router/auth.router.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> errorHandler = <span class="built_in">require</span>(<span class="string">&quot;./errorHandler.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册body-parser</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line"><span class="comment">// 注册路由</span></span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(authRouter.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(authRouter.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听错误</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>,errorHandler);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=app;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>postman</code>进行测试</li>
</ul>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/userLogin11673225250527.png" alt="userLogin1"></p>
<blockquote>
<p>壳子套好了，但是现在是个用户就能登录。需要添加登录条件，登录的时候判断用户是否存在，判断用户和密码输入的是否正确。。。</p>
</blockquote>
<h3 id="登录条件"><a href="#登录条件" class="headerlink" title="登录条件"></a>登录条件</h3><blockquote>
<p>通过中间件的方式来写入限制条件</p>
</blockquote>
<ul>
<li>在<code>middleware</code>下新建<code>auth.middleware.js</code>，用来做登录的限制；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;getUserByName&#125; = <span class="built_in">require</span>(<span class="string">&quot;../service/user.service.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> md5Password = <span class="built_in">require</span>(<span class="string">&quot;../utils/password-handle.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">vertifyLogin</span> = <span class="keyword">async</span>(<span class="params">ctx,next</span>)=&gt;&#123;</span><br><span class="line">    <span class="comment">// 1.获取用户名和密码</span></span><br><span class="line">    <span class="keyword">const</span> &#123;name,password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 2.判断用户名或密码是否为空</span></span><br><span class="line">    <span class="keyword">if</span>(!name||!password)&#123;</span><br><span class="line">        <span class="keyword">const</span> loginError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NAME_OR_PASSWORD_IS_REQUIRED</span>);</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,loginError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.判断用户名是否存在</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getUserByName</span>(name);</span><br><span class="line">    <span class="keyword">let</span> user = result[<span class="number">0</span>];</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(user);</span><br><span class="line">    <span class="keyword">if</span>(!user)&#123;</span><br><span class="line">        <span class="keyword">const</span> loginError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">USER_IS_NOT_EXIT</span>);</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,loginError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.验证密码是否和数据库中的密码一致(加密)</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">md5Password</span>(password)!==user.<span class="property">password</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> loginError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">PASSWORD_IS_INCORRENT</span>);</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,loginError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=&#123;</span><br><span class="line">    vertifyLogin,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>router</code>的<code>auth.router.js</code>引入中间件；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;login&#125; =<span class="built_in">require</span>(<span class="string">&quot;../controller/auth.controller.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;vertifyLogin&#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> authRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>:<span class="string">&quot;/login&quot;</span>&#125;);</span><br><span class="line">authRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,vertifyLogin,login);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=authRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li>中间件错误变量，放在在错误变量<code>constants</code>文件夹下的<code>error-types.js</code>里；(<code>app/index.js</code>监听错误处理，这里登录接口写了，不需要更改)；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span> = <span class="string">&quot;name_or_password_is_required&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">USER_IS_EXIT</span>=<span class="string">&quot;user_is_exit&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">USER_IS_NOT_EXIT</span>=<span class="string">&quot;user_is_not_exit&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PASSWORD_IS_INCORRENT</span>=<span class="string">&quot;password_id_incorrent&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=&#123;</span><br><span class="line">    <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span>,</span><br><span class="line">    <span class="variable constant_">USER_IS_EXIT</span>,</span><br><span class="line">    <span class="variable constant_">USER_IS_NOT_EXIT</span>,</span><br><span class="line">    <span class="variable constant_">PASSWORD_IS_INCORRENT</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>app</code>文件夹下的<code>errorHandler.js</code>下做变量的错误处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">errorHandler</span> = (<span class="params">error, ctx</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// console.log(error.message);</span></span><br><span class="line">    <span class="keyword">let</span> status, message;</span><br><span class="line">    <span class="keyword">switch</span> (error.<span class="property">message</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> errorType.<span class="property">NAME_OR_PASSWORD_IS_REQUIRED</span>:</span><br><span class="line">            status = <span class="number">400</span>; <span class="comment">//Bad Request</span></span><br><span class="line">            message = <span class="string">&quot;用户名或密码不能为空&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> errorType.<span class="property">USER_IS_EXIT</span>:</span><br><span class="line">            status = <span class="number">409</span>; <span class="comment">//conflict</span></span><br><span class="line">            message = <span class="string">&quot;用户名已存在~&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> errorType.<span class="property">USER_IS_NOT_EXIT</span>:</span><br><span class="line">            status = <span class="number">400</span>; <span class="comment">//请求参数错误</span></span><br><span class="line">            message = <span class="string">&quot;用户不存在&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> errorType.<span class="property">PASSWORD_IS_INCORRENT</span>:</span><br><span class="line">            status = <span class="number">400</span>; <span class="comment">//请求参数错误</span></span><br><span class="line">            message = <span class="string">&quot;用户名或密码错误&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            status = <span class="number">404</span>;</span><br><span class="line">            message = <span class="string">&quot;发生错误了~&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.<span class="property">status</span> = status;</span><br><span class="line">    ctx.<span class="property">body</span> = message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = errorHandler;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>postman</code>进行测试~</li>
</ul>
<h3 id="简化路由注册"><a href="#简化路由注册" class="headerlink" title="简化路由注册"></a>简化路由注册</h3><blockquote>
<p>现在注册了两个路由，<code>app/index.js</code>代码为：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser= <span class="built_in">require</span>(<span class="string">&quot;koa-bodyparser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&quot;../router/user.router.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> authRouter = <span class="built_in">require</span>(<span class="string">&quot;../router/auth.router.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> errorHandler = <span class="built_in">require</span>(<span class="string">&quot;./errorHandler.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册body-parser</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line"><span class="comment">// 注册路由</span></span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(authRouter.<span class="title function_">routes</span>());</span><br><span class="line">app.<span class="title function_">use</span>(authRouter.<span class="title function_">allowedMethods</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听错误</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>,errorHandler);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=app;</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>router</code>文件夹下新建<code>index.js</code>；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useRoutes</span> = (<span class="params">app</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// fs.readdirSync返回的是个数组;</span></span><br><span class="line">    fs.<span class="title function_">readdirSync</span>(__dirname).<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file == <span class="string">&quot;index.js&quot;</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">`./<span class="subst">$&#123;file&#125;</span>`</span>);</span><br><span class="line">        app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>());</span><br><span class="line">        app.<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>());</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=useRoutes;</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>app</code>文件夹下<code>index.js</code>中进行引入；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser= <span class="built_in">require</span>(<span class="string">&quot;koa-bodyparser&quot;</span>);</span><br><span class="line"><span class="comment">// const userRouter = require(&quot;../router/user.router.js&quot;);</span></span><br><span class="line"><span class="comment">// const authRouter = require(&quot;../router/auth.router.js&quot;);</span></span><br><span class="line"><span class="keyword">const</span> useRoutes = <span class="built_in">require</span>(<span class="string">&quot;../router/index.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> errorHandler = <span class="built_in">require</span>(<span class="string">&quot;./errorHandler.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册body-parser</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line"><span class="comment">// 注册路由</span></span><br><span class="line"><span class="title function_">useRoutes</span>(app); <span class="comment">//传参app参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听错误</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>,errorHandler);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=app;</span><br></pre></td></tr></table></figure>

<h3 id="登录凭证"><a href="#登录凭证" class="headerlink" title="登录凭证"></a>登录凭证</h3><blockquote>
<p>登录成功返回凭证：<code>cookie+session</code>或者是<code>Token令牌</code>；现在基本都是<code>Token令牌</code>作为登录凭证；</p>
</blockquote>
<h4 id="为什么需要登录凭证呢？"><a href="#为什么需要登录凭证呢？" class="headerlink" title="为什么需要登录凭证呢？"></a>为什么需要登录凭证呢？</h4><blockquote>
<p>web开发中，我们使用最多的协议是<code>http</code>，但是<code>http</code>是一个<strong>无状态</strong>的协议。那什么叫做无状态协议呢？</p>
</blockquote>
<ul>
<li>举个例子：<ul>
<li>我们登录了一个网站 <a target="_blank" rel="noopener" href="http://www.fsllala.top;/">www.fsllala.top；</a></li>
<li>登录的时候我们需要输入用户名和密码：比如用户名<code>forward</code>，密码：<code>Forward666</code>;</li>
<li>登录成功之后，我们要以<code>forward</code>的身份去访问其他的数据和资源，还是通过<code>http</code>请求去访问。<ul>
<li>fsllala的服务器会问：你谁呀？</li>
<li>forward说：我是forward呀，刚刚登录过呀；</li>
<li>fsllala：怎么证明你刚刚登录过呀？</li>
<li>forward说：这。。。，http没有告诉你吗？</li>
<li>fsllala：http的每次请求对我来说都是一个单独的请求，和之前请求过什么没有关系。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/1673224477117cookie.png"></p>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/1673224528691cookie.png"></p>
<blockquote>
<p>看到了吧？这就是http的无状态，也就是服务器不知道你上一步做了什么，我们必须得有一个办法可以证明我们登录过；</p>
</blockquote>
<ul>
<li>那如何证明刚才就是我登录的啊？<ul>
<li>登陆成功的时候服务器给我们发过来一个<strong>登录凭证</strong>，访问其他资源的时候，通过这个<strong>登录凭证</strong>来证明刚才就是我登录的，而且我能访问哪些资源，不能访问哪些资源，都可以通过<strong>登录凭证</strong>来决定；</li>
</ul>
</li>
</ul>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/1673224500212cookie.png"></p>
<ul>
<li>目前登录凭证有两种：<ul>
<li><code>cookie+session</code>(逐渐淘汰)</li>
<li><code>Token</code>令牌</li>
</ul>
</li>
</ul>
<p><strong>详细文章，参考 <a href="https://fsllala.top/articles/5fc41a6b">NodeJs 登录凭证</a></strong></p>
<h3 id="JWT颁发签名"><a href="#JWT颁发签名" class="headerlink" title="JWT颁发签名"></a>JWT颁发签名</h3><ul>
<li>我们在<code>vertifyLogin</code>中间件中查询到了用户数据，我们需要将用户的<code>id</code>、<code>name</code>和<code>生成的token</code>返回给用户；所以可以在<code>vertifyLogin</code>中间件中，将用户的数据绑定在<code>ctx</code>中(类似于原型)；最后在<code>login</code>中间件即<code>controller</code>里面获取用户数据，进行<code>token生成</code>和数据的返回；</li>
<li>采用<code>非对称加密</code>，将生成的<code>私钥</code>和<code>公钥</code>放到<code>app</code>文件夹下(公共的数据)；</li>
</ul>
<ol>
<li><code>middleware</code>文件夹下，将从<code>数据库</code>中获取到的<code>user</code>绑定在<code>ctx</code>对象上,用于<code>controller</code>获取用户数据；</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将user绑定在ctx对象上,用于controller获取用户数据</span><br><span class="line">ctx.<span class="property">user</span>=user;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>middleware/auth.middleware.js</code>完整代码：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;getUserByName&#125; = <span class="built_in">require</span>(<span class="string">&quot;../service/user.service.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> md5Password = <span class="built_in">require</span>(<span class="string">&quot;../utils/password-handle.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">vertifyLogin</span> = <span class="keyword">async</span>(<span class="params">ctx,next</span>)=&gt;&#123;</span><br><span class="line">    <span class="comment">// 1.获取用户名和密码</span></span><br><span class="line">    <span class="keyword">const</span> &#123;name,password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 2.判断用户名或密码是否为空</span></span><br><span class="line">    <span class="keyword">if</span>(!name||!password)&#123;</span><br><span class="line">        <span class="keyword">const</span> loginError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NAME_OR_PASSWORD_IS_REQUIRED</span>);</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,loginError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.判断用户名是否存在</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">getUserByName</span>(name);</span><br><span class="line">    <span class="keyword">let</span> user = result[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// console.log(user);</span></span><br><span class="line">    <span class="keyword">if</span>(!user)&#123;</span><br><span class="line">        <span class="keyword">const</span> loginError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">USER_IS_NOT_EXIT</span>);</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,loginError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.验证密码是否和数据库中的密码一致(加密)</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">md5Password</span>(password)!==user.<span class="property">password</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> loginError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">PASSWORD_IS_INCORRENT</span>);</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>,loginError,ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.将user绑定在ctx对象上,用于controller获取用户数据</span></span><br><span class="line">    ctx.<span class="property">user</span>=user;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>=&#123;</span><br><span class="line">    vertifyLogin,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>app</code>下的<code>config.js</code>读取<code>key</code>并导出；</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dotenv = <span class="built_in">require</span>(<span class="string">&quot;dotenv&quot;</span>);</span><br><span class="line">dotenv.<span class="title function_">config</span>(); <span class="comment">//将.env中的变量挂载到process.env中</span></span><br><span class="line"><span class="comment">// console.log(process.env.APP_PORT);</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PRIVATE_KEY</span> = fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;./keys/private.key&quot;</span>));</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PUBLIC_KEY</span> = fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;./keys/public.key&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="variable constant_">APP_PORT</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PORT</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_DATABASE</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_USER</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PASSWORD</span>,</span><br><span class="line"></span><br><span class="line">&#125; = process.<span class="property">env</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里不能写在module.exports上面,原因可参考模块化规范一文；</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">PRIVATE_KEY</span> = <span class="variable constant_">PRIVATE_KEY</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">PUBLIC_KEY</span> = <span class="variable constant_">PUBLIC_KEY</span>;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装<code>jsonwebtoken</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i jsonwebtoken</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在<code>controller</code>下的<code>auth.controller.js</code>中做<code>token</code>的返回；</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&quot;jsonwebtoken&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">PRIVATE_KEY</span>&#125; = <span class="built_in">require</span>(<span class="string">&quot;../app/config.js&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthController</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="comment">// const &#123;name&#125; = ctx.request.body;</span></span><br><span class="line">        <span class="comment">// ctx.body = `欢迎$&#123;name&#125;回来~`;</span></span><br><span class="line">        <span class="keyword">const</span> &#123;id,name&#125;=ctx.<span class="property">user</span>;</span><br><span class="line">        <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123;id,name&#125;,<span class="variable constant_">PRIVATE_KEY</span>,&#123;</span><br><span class="line">            <span class="attr">expiresIn</span>:<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>,</span><br><span class="line">            <span class="attr">algorithm</span>:<span class="string">&quot;RS256&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//返回对象形式的数据(ES6简写)</span></span><br><span class="line">        ctx.<span class="property">body</span>=&#123;</span><br><span class="line">            id,</span><br><span class="line">            name,</span><br><span class="line">            token</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">AuthController</span>();</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>使用<code>postman</code>进行测试；(填入数据库存在的用户)；</li>
</ol>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/token81673958231583.png"></p>
<ol start="6">
<li>设计个简单的接口，验证上面写的登录接口；（这一步实际项目不用做，做的话看下一步骤7）</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在controller下的auth.controller.js下</span></span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&quot;jsonwebtoken&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="variable constant_">PRIVATE_KEY</span>, <span class="variable constant_">PUBLIC_KEY</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;../app/config.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types.js&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthController</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证token</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">vertifyToken</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> authorization = ctx.<span class="property">headers</span>.<span class="property">authorization</span>;</span><br><span class="line">    <span class="comment">// 此时的token多一个&quot;Bearer &quot;,去掉;</span></span><br><span class="line">    <span class="keyword">const</span> token = authorization.<span class="title function_">replace</span>(<span class="string">&quot;Bearer &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// 认证token 通过 jwt.verify(token,key); 使用公钥进行解密,并告诉其加密算法;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> result = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">PUBLIC_KEY</span>, &#123;</span><br><span class="line">        <span class="attr">algorithms</span>: [<span class="string">&quot;RS256&quot;</span>], <span class="comment">//这里algorithms是个复数,所以需要传入数组;</span></span><br><span class="line">      &#125;);</span><br><span class="line">      ctx.<span class="property">body</span> = result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">const</span> tokenError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">UNAUTHORIZATION</span>);</span><br><span class="line">      <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>, tokenError, ctx);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">AuthController</span>();</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在constants下的error-types.js下</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span> = <span class="string">&quot;name_or_password_is_required&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">USER_IS_EXIT</span> = <span class="string">&quot;user_is_exit&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">USER_IS_NOT_EXIT</span> = <span class="string">&quot;user_is_not_exit&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PASSWORD_IS_INCORRENT</span> = <span class="string">&quot;password_is_incorrent&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">UNAUTHORIZATION</span> = <span class="string">&quot;unauthorization&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span>,</span><br><span class="line">  <span class="variable constant_">USER_IS_EXIT</span>,</span><br><span class="line">  <span class="variable constant_">USER_IS_NOT_EXIT</span>,</span><br><span class="line">  <span class="variable constant_">PASSWORD_IS_INCORRENT</span>,</span><br><span class="line">  <span class="variable constant_">UNAUTHORIZATION</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在app下的errorHandler.js下</span></span><br><span class="line">  <span class="keyword">case</span> errorType.<span class="property">UNAUTHORIZATION</span>:</span><br><span class="line">    status = <span class="number">401</span>; </span><br><span class="line">    message = <span class="string">&quot;无效的token~&quot;</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在router下的auth.router.js下</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; vertifyLogin &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; login,vertifyToken &#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/auth.controller.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> authRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/login&quot;</span> &#125;);</span><br><span class="line">authRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>, vertifyLogin, login);</span><br><span class="line">authRouter.<span class="title function_">get</span>(<span class="string">&quot;/&quot;</span>, vertifyToken);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = authRouter;</span><br></pre></td></tr></table></figure>

<p>使用postman，填入token，进行测试<code>&#123;&#123;baseUrl&#125;&#125;/login</code>；</p>
<ol start="7">
<li>实际项目中，几乎每个接口都需要验证token，所以需要将6中的验证token的逻辑提取到中间件中；以后别的接口需要验证token的话，直接引入这个验证token的中间件就行。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在middleware的auth.middleware.js下</span></span><br><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; getUserByName &#125; = <span class="built_in">require</span>(<span class="string">&quot;../service/user.service.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> md5Password = <span class="built_in">require</span>(<span class="string">&quot;../utils/password-handle.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&quot;jsonwebtoken&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="variable constant_">PUBLIC_KEY</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;../app/config.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">vertifyLogin</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证token是否有效</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">vertifyToken</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> authorization = ctx.<span class="property">headers</span>.<span class="property">authorization</span>;</span><br><span class="line">  <span class="comment">// 验证是否携带TOKEN</span></span><br><span class="line">  <span class="keyword">if</span>(!authorization)&#123;</span><br><span class="line">    <span class="keyword">const</span> tokenError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">UNAUTHORIZATION</span>);</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>, tokenError, ctx);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 此时的token多一个&quot;Bearer &quot;,去掉;</span></span><br><span class="line">  <span class="keyword">const</span> token = authorization.<span class="title function_">replace</span>(<span class="string">&quot;Bearer &quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="comment">// 认证token 通过 jwt.verify(token,key); 使用公钥进行解密,并告诉其加密算法;</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 获取到token中信息(id.name...)</span></span><br><span class="line">    <span class="keyword">const</span> result = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">PUBLIC_KEY</span>, &#123;</span><br><span class="line">      <span class="attr">algorithms</span>: [<span class="string">&quot;RS256&quot;</span>], <span class="comment">//这里algorithms是个复数,所以需要传入数组;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 将token信息保留下来,以便后续使用</span></span><br><span class="line">    ctx.<span class="property">userInfo</span> = result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行下一个中间件;</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">const</span> tokenError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">UNAUTHORIZATION</span>);</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>, tokenError, ctx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  vertifyLogin,</span><br><span class="line">  vertifyToken</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在constants下的error-types.js下</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span> = <span class="string">&quot;name_or_password_is_required&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">USER_IS_EXIT</span> = <span class="string">&quot;user_is_exit&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">USER_IS_NOT_EXIT</span> = <span class="string">&quot;user_is_not_exit&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PASSWORD_IS_INCORRENT</span> = <span class="string">&quot;password_is_incorrent&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">UNAUTHORIZATION</span> = <span class="string">&quot;unauthorization&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span>,</span><br><span class="line">  <span class="variable constant_">USER_IS_EXIT</span>,</span><br><span class="line">  <span class="variable constant_">USER_IS_NOT_EXIT</span>,</span><br><span class="line">  <span class="variable constant_">PASSWORD_IS_INCORRENT</span>,</span><br><span class="line">  <span class="variable constant_">UNAUTHORIZATION</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在app下的errorHandler.js下</span></span><br><span class="line">  <span class="keyword">case</span> errorType.<span class="property">UNAUTHORIZATION</span>:</span><br><span class="line">    status = <span class="number">401</span>; </span><br><span class="line">    message = <span class="string">&quot;无效的token~&quot;</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在router下的auth.router.js下</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; vertifyLogin,vertifyToken&#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; login &#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/auth.controller.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> authRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/login&quot;</span> &#125;);</span><br><span class="line">authRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>, vertifyLogin, login);</span><br><span class="line">authRouter.<span class="title function_">get</span>(<span class="string">&quot;/&quot;</span>, vertifyToken);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = authRouter;</span><br></pre></td></tr></table></figure>

<p>使用postman，填入token，进行测试<code>&#123;&#123;baseUrl&#125;&#125;/login</code>；</p>
<h2 id="动态信息接口-一对多"><a href="#动态信息接口-一对多" class="headerlink" title="动态信息接口(一对多)"></a>动态信息接口(一对多)</h2><blockquote>
<p>设计表字段思路：谁，发表了什么动态信息；</p>
<p>一条动态(含唯一id)，只能是一个用户发布的；一个用户，可以发表多条动态信息(含唯一id)；</p>
<p>属于”一对多”关系型数据库表；</p>
</blockquote>
<h3 id="数据库表"><a href="#数据库表" class="headerlink" title="数据库表"></a>数据库表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `moment`(</span><br><span class="line"> id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line"> content <span class="type">VARCHAR</span>(<span class="number">1000</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"> user_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"> ctrateTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line"> updateTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line"> <span class="keyword">FOREIGN</span> KEY(user_id) <span class="keyword">REFERENCES</span> <span class="keyword">user</span>(id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="发表动态"><a href="#发表动态" class="headerlink" title="发表动态"></a>发表动态</h3><ul>
<li><code>router</code>文件夹下新建<code>moment.router.js</code>，用来存放用户动态的路由逻辑；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在简化路由注册中,实现了路由的自动引入;因此,不需要手动引入路由;</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; vertifyToken &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; postUpdates &#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/moment.controller&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> momentRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/moment&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发表动态(登录之后才能,引入验证token的中间件)</span></span><br><span class="line">momentRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>, vertifyToken, postUpdates);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = momentRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下新建<code>moment.controller.js</code>，用来存放中间件的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 啥逻辑也不写,进行简单的接口验证</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MomentController</span> &#123;</span><br><span class="line">    <span class="comment">// 发表动态</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">postUpdates</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    ctx.<span class="property">body</span>=<span class="string">&quot;发表动态成功~&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">MomentController</span>();</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进行逻辑的处理</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MomentController</span> &#123;</span><br><span class="line">    <span class="comment">// 发表动态</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">postUpdates</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 1.获取动态的内容;</span></span><br><span class="line">    <span class="keyword">const</span> &#123;content&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 2.动态是谁发布的(谁登录就是谁发布的,登录的时候再ctx上绑定了user属性);</span></span><br><span class="line">    <span class="keyword">const</span> &#123;id&#125; = ctx.<span class="property">user</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.将动态存储到数据库中;(需要放到service层)</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">MomentController</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下新建<code>moment.service.js</code>，用来存放中间件的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可能插入失败,需要修改数据表content字符集为 utf8;</span></span><br><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="comment">// 数据库插入数据</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">contents,userId</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO moment(content,user_id) VALUES(?,?)`</span>;</span><br><span class="line">    <span class="comment">// 返回的是一个[&#123;&#125;]格式的数据,lenth为1;采用数组结构,获取[]中的&#123;&#125;;</span></span><br><span class="line">    <span class="keyword">const</span> [serviceResult] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[contents,userId]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serviceResult;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// moment.controller.js</span></span><br><span class="line"><span class="keyword">const</span> momentService = <span class="built_in">require</span>(<span class="string">&quot;../service/moment.service&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MomentController</span> &#123;</span><br><span class="line">  <span class="comment">// 发表动态</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">postUpdates</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 1.获取动态的内容;</span></span><br><span class="line">    <span class="keyword">const</span> &#123; content &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 2.动态是谁发布的(谁登录就是谁发布的,验证token的时候再ctx上绑定了userInfo属性);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = ctx.<span class="property">userInfo</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.将动态存储到数据库中;(需要放到service层)</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">create</span>(content, id);</span><br><span class="line">    <span class="comment">// 4.返回数据</span></span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;发布动态成功&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: result,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">MomentController</span>();</span><br></pre></td></tr></table></figure>

<h3 id="查询动态列表"><a href="#查询动态列表" class="headerlink" title="查询动态列表"></a>查询动态列表</h3><blockquote>
<p>查询一般涉及到了分页的处理。</p>
</blockquote>
<ul>
<li><code>router</code>文件夹下的<code>moment.router.js</code>，新增查询用户动态的路由逻辑；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; vertifyToken &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; postUpdates,list &#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/moment.controller&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> momentRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/moment&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发表动态(登录之后才能,引入验证token的中间件)</span></span><br><span class="line">momentRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>, vertifyToken, postUpdates);</span><br><span class="line"><span class="comment">// 查询动态(这个不登录也能看动态的)</span></span><br><span class="line">momentRouter.<span class="title function_">get</span>(<span class="string">&quot;/list&quot;</span>, list);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = momentRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下的<code>moment.controller.js</code>，新增查询中间件的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> momentService = <span class="built_in">require</span>(<span class="string">&quot;../service/moment.service&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MomentController</span> &#123;</span><br><span class="line">  <span class="comment">// 发表动态</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">postUpdates</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 1.获取动态的内容;</span></span><br><span class="line">    <span class="keyword">const</span> &#123; content &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 2.动态是谁发布的(谁登录就是谁发布的,验证token的时候再ctx上绑定了userInfo属性);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = ctx.<span class="property">userInfo</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.将动态存储到数据库中;(需要放到service层)</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">create</span>(content, id);</span><br><span class="line">    <span class="comment">// 4.返回数据</span></span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;发布动态成功&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: result,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询动态</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">list</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取 size与offset</span></span><br><span class="line">    <span class="keyword">const</span> &#123; size,offset &#125; = ctx.<span class="property">query</span>;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">queryList</span>(size,offset);</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;查询动态成功&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: result,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">MomentController</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下的<code>moment.service.js</code>，新增查询中间件的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"><span class="comment">// 专门做数据库操作的;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="comment">// 数据库插入数据</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">contents,userId</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO moment(content,user_id) VALUES(?,?)`</span>;</span><br><span class="line">    <span class="comment">// 返回的是一个[&#123;&#125;]格式的数据,lenth为1;采用数组结构,获取[]中的&#123;&#125;;</span></span><br><span class="line">    <span class="keyword">const</span> [serviceResult] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[contents,userId]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serviceResult;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询数据列表</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">queryList</span>(<span class="params">size,offset</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM moment LIMIT ? OFFSET ?`</span>;</span><br><span class="line">    <span class="comment">// 这里如果写成String()的话,如果用户不传size,offset,接口也能通;如果是Number的话,会报错;</span></span><br><span class="line">    <span class="keyword">const</span> [serviceResult] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[<span class="title class_">String</span>(size),<span class="title class_">String</span>(offset)]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serviceResult;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>访问<code>moment/list?size=10&amp;offset=0</code>，进行动态列表数据的分页查询。</p>
</blockquote>
<p>但是现在返回的数据，其实仅仅是当前的<code>moment</code>数据表中的数据，不能知道是谁评论的，需要用外键<code>user_id</code>与<code>user</code>表关联起来；</p>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/koa_momentList1.png"></p>
<ul>
<li>多表查询</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> 基础写法(没有数据格式处理,字段没有过滤)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> moment </span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> `<span class="keyword">user</span>` <span class="keyword">ON</span> user.id<span class="operator">=</span>moment.user_id</span><br><span class="line">LIMIT <span class="number">10</span> <span class="keyword">OFFSET</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> 进阶</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">m.id <span class="keyword">as</span> id,m.content content,m.ctrateTime ctrateTime,m.updateTime updateTime,</span><br><span class="line"><span class="built_in">JSON_OBJECT</span>(<span class="string">&#x27;id&#x27;</span>,u.id,<span class="string">&#x27;name&#x27;</span>,u.name) <span class="keyword">as</span> userInfo</span><br><span class="line"><span class="keyword">FROM</span> moment <span class="keyword">as</span> m</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> `<span class="keyword">user</span>` <span class="keyword">as</span> u <span class="keyword">ON</span> u.id<span class="operator">=</span>m.user_id</span><br><span class="line">LIMIT <span class="number">10</span> <span class="keyword">OFFSET</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/koa_momentList2.png"></p>
<ul>
<li><code>service</code>文件夹下的<code>moment.service.js</code>，修改查询SQL语句；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"><span class="comment">// 专门做数据库操作的;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="comment">// 数据库插入数据</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">contents,userId</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO moment(content,user_id) VALUES(?,?)`</span>;</span><br><span class="line">    <span class="comment">// 返回的是一个[&#123;&#125;]格式的数据,lenth为1;采用数组结构,获取[]中的&#123;&#125;;</span></span><br><span class="line">    <span class="keyword">const</span> [serviceResult] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[contents,userId]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serviceResult;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询数据列表</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">queryList</span>(<span class="params">size,offset</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT </span></span><br><span class="line"><span class="string">    m.id as id,m.content content,m.ctrateTime ctrateTime,m.updateTime updateTime,</span></span><br><span class="line"><span class="string">    JSON_OBJECT(&#x27;id&#x27;,u.id,&#x27;name&#x27;,u.name) as userInfo</span></span><br><span class="line"><span class="string">    FROM moment as m</span></span><br><span class="line"><span class="string">    LEFT JOIN user as u ON u.id=m.user_id</span></span><br><span class="line"><span class="string">    LIMIT ? OFFSET ?`</span>;</span><br><span class="line">    <span class="comment">// 这里如果写成String()的话,如果用户不传size,offset,接口也能通;如果是Number的话,会报错;</span></span><br><span class="line">    <span class="keyword">const</span> [serviceResult] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[<span class="title class_">String</span>(size),<span class="title class_">String</span>(offset)]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serviceResult;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>访问<code>moment/list?size=10&amp;offset=0</code>，进行动态列表数据的分页查询，查询结果如下图所示</p>
</blockquote>
<p><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/koa_momentList3.png"></p>
<h3 id="查询动态详情"><a href="#查询动态详情" class="headerlink" title="查询动态详情"></a>查询动态详情</h3><blockquote>
<p>获取列表某一条数据的详情。</p>
</blockquote>
<ul>
<li><code>router</code>文件夹下的<code>moment.router.js</code>，新增查询用户动态详情接口；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; vertifyToken &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; postUpdates,list,detail&#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/moment.controller&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> momentRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/moment&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发表动态(登录之后才能,引入验证token的中间件)</span></span><br><span class="line">momentRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>, vertifyToken, postUpdates);</span><br><span class="line"><span class="comment">// 查询动态(这个不登录也能看动态的)</span></span><br><span class="line">momentRouter.<span class="title function_">get</span>(<span class="string">&quot;/list&quot;</span>, list);</span><br><span class="line"><span class="comment">// 查询动态详情</span></span><br><span class="line">momentRouter.<span class="title function_">get</span>(<span class="string">&quot;/:momentId&quot;</span>, detail);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = momentRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下的<code>moment.controller.js</code>，新增查询中间件的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询动态详情</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">detail</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; momentId &#125; = ctx.<span class="property">params</span>;</span><br><span class="line">  <span class="comment">// console.log(momentId);</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">queryDetailById</span>(momentId);</span><br><span class="line">  ctx.<span class="property">body</span> = &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&quot;查询动态详情成功&quot;</span>,</span><br><span class="line">    <span class="attr">data</span>: result,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下的<code>moment.service.js</code>，新增查询中间件的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"><span class="comment">// 专门做数据库操作的;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="comment">// 数据库插入数据</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">contents,userId</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO moment(content,user_id) VALUES(?,?)`</span>;</span><br><span class="line">    <span class="comment">// 返回的是一个[&#123;&#125;]格式的数据,lenth为1;采用数组结构,获取[]中的&#123;&#125;;</span></span><br><span class="line">    <span class="keyword">const</span> [serviceResult] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[contents,userId]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serviceResult;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询数据列表</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">queryList</span>(<span class="params">size,offset</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT </span></span><br><span class="line"><span class="string">    m.id as id,m.content content,m.ctrateTime ctrateTime,m.updateTime updateTime,</span></span><br><span class="line"><span class="string">    JSON_OBJECT(&#x27;id&#x27;,u.id,&#x27;name&#x27;,u.name) as userInfo</span></span><br><span class="line"><span class="string">    FROM moment as m</span></span><br><span class="line"><span class="string">    LEFT JOIN user as u ON u.id=m.user_id</span></span><br><span class="line"><span class="string">    LIMIT ? OFFSET ?`</span>;</span><br><span class="line">    <span class="comment">// 这里如果写成String()的话,如果用户不传size,offset,接口也能通;如果是Number的话,会报错;</span></span><br><span class="line">    <span class="keyword">const</span> [serviceResult] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[<span class="title class_">String</span>(size),<span class="title class_">String</span>(offset)]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serviceResult;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询动态详情(将&#x27;查询数据列表&#x27;的LIMIT...ON...改为WHERE...即可)</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">queryDetailById</span>(<span class="params">momentId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT </span></span><br><span class="line"><span class="string">    m.id as id,m.content content,m.ctrateTime ctrateTime,m.updateTime updateTime,</span></span><br><span class="line"><span class="string">    JSON_OBJECT(&#x27;id&#x27;,u.id,&#x27;name&#x27;,u.name) as userInfo</span></span><br><span class="line"><span class="string">    FROM moment as m</span></span><br><span class="line"><span class="string">    LEFT JOIN user as u ON u.id=m.user_id</span></span><br><span class="line"><span class="string">    WHERE m.id=?`</span>;</span><br><span class="line">    <span class="keyword">const</span> [serviceResult] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[momentId]);</span><br><span class="line">    <span class="keyword">return</span> serviceResult;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过<code>/moment/1</code>(GET)获取详情数据。</p>
</blockquote>
<h3 id="修改动态"><a href="#修改动态" class="headerlink" title="修改动态"></a>修改动态</h3><blockquote>
<p>修改列表某一条数据的详情。</p>
</blockquote>
<ul>
<li><code>router</code>文件夹下的<code>moment.router.js</code>，新增修改用户动态接口；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">momentRouter.<span class="title function_">patch</span>(<span class="string">&quot;/:momentId&quot;</span>, vertifyToken, update);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下的<code>moment.controller.js</code>，新增修改用户的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改动态</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">update</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; momentId &#125; = ctx.<span class="property">params</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; content &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">updateById</span>(content, momentId);</span><br><span class="line">  ctx.<span class="property">body</span> = &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&quot;修改动态成功&quot;</span>,</span><br><span class="line">    <span class="attr">data</span>: result,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下的<code>moment.service.js</code>，新增修改用户的SQL操作；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改动态</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">updateById</span>(<span class="params">content,momentId</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">`UPDATE moment SET content=? WHERE id=?`</span>;</span><br><span class="line">  <span class="keyword">const</span> [serviceResult] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[content,momentId]);</span><br><span class="line">  <span class="keyword">return</span> serviceResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过<code>/moment/1</code>(PATCH)修改详情数据。</p>
</blockquote>
<p>但是现在只要<code>token</code>有效，所有人的动态信息都能修改；正常来说，只能修改私人的动态，即：用户登录的id和数据库表中发表此动态的id一致可以修改，否则不能修改；</p>
<ul>
<li>增加验证修改权限的中间件</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> 此<span class="keyword">SQL</span>语句包含了查询的ID与用户的ID;如果筛选条件都满足的话返回一条数据,否则为空;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> moment <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> user_id <span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>router</code>文件夹下的<code>moment.router.js</code>，新增修改用户动态权限的验证；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; vertifyToken &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;vertifyMomentPermission&#125;= <span class="built_in">require</span>(<span class="string">&quot;../middleware/permission.middleware&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; postUpdates,list,detail,update&#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/moment.controller&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> momentRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/moment&quot;</span> &#125;);</span><br><span class="line"><span class="comment">// 修改动态(登录之后才能,引入验证token的中间件)</span></span><br><span class="line"><span class="comment">// 用户登录的id和数据库表中发表此动态的id一致可以修改，否则不能修改</span></span><br><span class="line">momentRouter.<span class="title function_">patch</span>(<span class="string">&quot;/:momentId&quot;</span>, vertifyToken, vertifyMomentPermission,update);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = momentRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>middleware</code>文件夹下新建<code>permission.middleware.js</code>，验证登录的id是否有权限更改相关数据；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&quot;../constants/error-types&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> permissionService = <span class="built_in">require</span>(<span class="string">&quot;../service/permission.service&quot;</span>);</span><br><span class="line"><span class="comment">// 验证登录的id是否有权限更改相关数据</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">vertifyMomentPermission</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 上个验证token的中间件在ctx上绑定了userInfo,即登录的用户信息;</span></span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = ctx.<span class="property">userInfo</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; momentId &#125; = ctx.<span class="property">params</span>;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> permissionService.<span class="title function_">checkMoment</span>(id, momentId);</span><br><span class="line">  <span class="keyword">if</span> (result.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> permissionError = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NO_PERMISSION</span>);</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>, permissionError, ctx);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  vertifyMomentPermission,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下新建<code>permission.service.js</code>，用户查询数据库；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PermissionService</span> &#123;</span><br><span class="line">    <span class="comment">// 数据库查看是否存在相应权限</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">checkMoment</span>(<span class="params">userId, momentId</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM moment WHERE id=? AND user_id=?`</span>;</span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement, [momentId, userId]);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">PermissionService</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>constants</code>文件夹下<code>error-types.js</code>，新增无权限的常量；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">NO_PERMISSION</span> = <span class="string">&quot;no_permission&quot;</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="variable constant_">NO_PERMISSION</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>app</code>文件夹下<code>errorHandler.js</code>，新增无权限的判断；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> errorType.<span class="property">NO_PERMISSION</span>:</span><br><span class="line">  status = <span class="number">403</span>; </span><br><span class="line">  message = <span class="string">&quot;权限不足~&quot;</span>;</span><br><span class="line"><span class="keyword">break</span>; </span><br></pre></td></tr></table></figure>

<h3 id="删除动态"><a href="#删除动态" class="headerlink" title="删除动态"></a>删除动态</h3><ul>
<li><code>router</code>文件夹下的<code>moment.router.js</code>，新增删除用户动态接口；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; vertifyToken &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;vertifyMomentPermission&#125;= <span class="built_in">require</span>(<span class="string">&quot;../middleware/permission.middleware&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; postUpdates,list,detail,update,remove&#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/moment.controller&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> momentRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/moment&quot;</span> &#125;);</span><br><span class="line"><span class="comment">// 删除动态</span></span><br><span class="line">momentRouter.<span class="title function_">delete</span>(<span class="string">&quot;/:momentId&quot;</span>, vertifyToken, vertifyMomentPermission,remove);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下的<code>moment.controller.js</code>，新增删除用户的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除动态</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">remove</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; momentId &#125; = ctx.<span class="property">params</span>;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">removeById</span>(momentId);</span><br><span class="line">  ctx.<span class="property">body</span> = &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&quot;删除动态成功&quot;</span>,</span><br><span class="line">    <span class="attr">data</span>: result,</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下的<code>moment.service.js</code>，新增删除用户的SQL操作；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除动态</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">removeById</span>(<span class="params">momentId</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> statement = <span class="string">`DELETE FROM moment WHERE id=?`</span>;</span><br><span class="line">  <span class="keyword">const</span> [serviceResult] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[momentId]);</span><br><span class="line">  <span class="keyword">return</span> serviceResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过<code>/moment/1</code>(DELETE)删除详情数据。</p>
</blockquote>
<h2 id="评论动态接口-一对多"><a href="#评论动态接口-一对多" class="headerlink" title="评论动态接口(一对多)"></a>评论动态接口(一对多)</h2><blockquote>
<p>设计表字段思路：谁，发表了什么评论，该评论评论了哪条动态；</p>
<p>一条评论(含唯一id)只能是一个用户发的，一个用户可以发多条评论(含唯一id)；</p>
<p>属于”一对多”关系型数据库表；</p>
</blockquote>
<h3 id="数据库表-1"><a href="#数据库表-1" class="headerlink" title="数据库表"></a>数据库表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--  创建comment 评论表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `comment`(</span><br><span class="line"> id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line"><span class="comment">--  评论的内容</span></span><br><span class="line"> content <span class="type">VARCHAR</span>(<span class="number">1000</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, </span><br><span class="line"><span class="comment">--  在哪条动态下评论的</span></span><br><span class="line"> moment_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="comment">--  谁评论的</span></span><br><span class="line"> user_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="comment">--  此条动态有多个评论,给每条评论一个id;就可以实现 评论 动态下面的某一条具体评论的效果(回复评论);</span></span><br><span class="line"> comment_id <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line"> ctrateTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line"> updateTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line"> <span class="keyword">FOREIGN</span> KEY(moment_id) <span class="keyword">REFERENCES</span> moment(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE,</span><br><span class="line"> <span class="keyword">FOREIGN</span> KEY(user_id) <span class="keyword">REFERENCES</span> <span class="keyword">user</span>(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE,</span><br><span class="line"><span class="comment">--  comment_id对应自身表中的id</span></span><br><span class="line"> <span class="keyword">FOREIGN</span> KEY(comment_id) <span class="keyword">REFERENCES</span> comment(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="发表评论"><a href="#发表评论" class="headerlink" title="发表评论"></a>发表评论</h3><blockquote>
<p>需要知道：谁，在哪个动态下，评论了什么内容；</p>
</blockquote>
<ul>
<li><code>router</code>文件夹下新建<code>comment.router.js</code>，用来存放发表评论的路由逻辑；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; vertifyToken &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; create &#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/comment.controller&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commentRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/comment&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 增：新增评论</span></span><br><span class="line">commentRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>, vertifyToken, create);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = commentRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下新建<code>comment.controller.js</code>，用来存放发表评论的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> commentService = <span class="built_in">require</span>(<span class="string">&quot;../service/comment.service&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommentController</span> &#123;</span><br><span class="line">  <span class="comment">// 发表动态</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取动态的内容,评论动态的Id</span></span><br><span class="line">    <span class="keyword">const</span> &#123; content, momentId &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 获取动态是谁发布的(谁登录就是谁发布的,验证token的时候再ctx上绑定了userInfo属性);</span></span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = ctx.<span class="property">userInfo</span>;</span><br><span class="line">    <span class="comment">// 将动态存储到数据库中;(需要放到service层)</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> commentService.<span class="title function_">create</span>(content, id, momentId);</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;发表评论成功&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: result,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">CommentController</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下新建<code>comment.service.js</code>，用来存放发表评论的SQL处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommentService</span> &#123;</span><br><span class="line">  <span class="comment">// 数据库插入数据</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">content, userId, momentId</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO comment (content,user_id,moment_id) VALUES (?,?,?)`</span>;</span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement, [content,userId,momentId]);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">CommentService</span>();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过<code>/comment</code>(POST)发表评论；例：body为</p>
<p><code>&#123;     &quot;content&quot;: &quot;kunkun打球好帅&quot;,     &quot;momentId&quot;: 3 &#125;</code></p>
<p>注：其中<code>momentId</code>的value值，必须是moment表中存在的，因为设置了外键约束。</p>
</blockquote>
<h3 id="回复评论"><a href="#回复评论" class="headerlink" title="回复评论"></a>回复评论</h3><blockquote>
<p>相比较于发表评论，回复评论需要多一个参数，即：<code>comment_id</code>；</p>
</blockquote>
<ul>
<li><code>router</code>文件夹下的<code>comment.router.js</code>，用来存放回复评论的路由逻辑；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; vertifyToken &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; create,reply &#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/comment.controller&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commentRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/comment&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 增：新增评论</span></span><br><span class="line">commentRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>, vertifyToken, create);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 增：回复评论</span></span><br><span class="line">commentRouter.<span class="title function_">post</span>(<span class="string">&quot;/reply&quot;</span>, vertifyToken, reply);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = commentRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下的<code>comment.controller.js</code>，用来存回复的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> commentService = <span class="built_in">require</span>(<span class="string">&quot;../service/comment.service&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommentController</span> &#123;</span><br><span class="line">  <span class="comment">// 发表动态</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取动态的内容,评论动态的Id</span></span><br><span class="line">    <span class="keyword">const</span> &#123; content, momentId &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 获取动态是谁发布的(谁登录就是谁发布的,验证token的时候再ctx上绑定了userInfo属性);</span></span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = ctx.<span class="property">userInfo</span>;</span><br><span class="line">    <span class="comment">// 将动态存储到数据库中;(需要放到service层)</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> commentService.<span class="title function_">create</span>(content, id, momentId);</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;发表评论成功&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: result,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 回复动态</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">reply</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取动态的内容,评论动态的Id,回复的Id</span></span><br><span class="line">    <span class="keyword">const</span> &#123; content, momentId,commentId &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 获取动态是谁发布的(谁登录就是谁发布的,验证token的时候再ctx上绑定了userInfo属性);</span></span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = ctx.<span class="property">userInfo</span>;</span><br><span class="line">    <span class="comment">// 将动态存储到数据库中;(需要放到service层)</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> commentService.<span class="title function_">reply</span>(content, id, momentId,commentId);</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;回复评论成功&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: result,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">CommentController</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下的<code>comment.service.js</code>，用来存放回复评论的SQL处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommentService</span> &#123;</span><br><span class="line">  <span class="comment">// 数据库插入数据</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">content, userId, momentId</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO comment (content,user_id,moment_id) VALUES (?,?,?)`</span>;</span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement, [content,userId,momentId]);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">reply</span>(<span class="params">content, userId, momentId,commentId</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO comment (content,user_id,moment_id,comment_id) VALUES (?,?,?,?)`</span>;</span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement, [content,userId,momentId,commentId]);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">CommentService</span>();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过<code>/comment/reply</code>(POST)发表评论；例：body为</p>
<p><code>&#123;     &quot;content&quot;: &quot;确实帅,我家鸽鸽太有实力了&quot;,     &quot;momentId&quot;: 3,     &quot;commentId&quot;:6 &#125;</code></p>
<p>注：其中<code>momentId/commentId</code>的value值，必须是moment&#x2F;comment表中存在的，因为设置了外键约束。</p>
</blockquote>
<h2 id="动态信息与评论接口-一对多"><a href="#动态信息与评论接口-一对多" class="headerlink" title="动态信息与评论接口(一对多)"></a>动态信息与评论接口(一对多)</h2><blockquote>
<p>一般来说，查询动态信息列表及详情的时候，也需要将评论一并查询出来。现需求如下：</p>
</blockquote>
<ul>
<li>查询动态列表时，显示评论的个数；</li>
<li>查询动态详情时，显示评论的列表；</li>
</ul>
<h3 id="查询动态列表-1"><a href="#查询动态列表-1" class="headerlink" title="查询动态列表"></a>查询动态列表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询动态列表SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">m.id <span class="keyword">as</span> id,m.content content,m.ctrateTime ctrateTime,m.updateTime updateTime,</span><br><span class="line"><span class="built_in">JSON_OBJECT</span>(<span class="string">&#x27;id&#x27;</span>,u.id,<span class="string">&#x27;name&#x27;</span>,u.name) <span class="keyword">as</span> userInfo</span><br><span class="line"><span class="keyword">FROM</span> moment <span class="keyword">as</span> m</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> `<span class="keyword">user</span>` <span class="keyword">as</span> u <span class="keyword">ON</span> u.id<span class="operator">=</span>m.user_id</span><br><span class="line">LIMIT <span class="number">10</span> <span class="keyword">OFFSET</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询评论个数SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> `comment` <span class="keyword">WHERE</span> moment_id<span class="operator">=</span><span class="number">3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 两者结合(SQL子查询)</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">m.id <span class="keyword">as</span> id,m.content content,m.ctrateTime ctrateTime,m.updateTime updateTime,</span><br><span class="line"><span class="built_in">JSON_OBJECT</span>(<span class="string">&#x27;id&#x27;</span>,u.id,<span class="string">&#x27;name&#x27;</span>,u.name) <span class="keyword">as</span> userInfo,</span><br><span class="line">(<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> comment <span class="keyword">WHERE</span> comment.moment_id<span class="operator">=</span>m.id) commentCount</span><br><span class="line"><span class="keyword">FROM</span> moment <span class="keyword">as</span> m</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> `<span class="keyword">user</span>` <span class="keyword">as</span> u <span class="keyword">ON</span> u.id<span class="operator">=</span>m.user_id</span><br><span class="line">LIMIT <span class="number">10</span> <span class="keyword">OFFSET</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="查询动态详情-1"><a href="#查询动态详情-1" class="headerlink" title="查询动态详情"></a>查询动态详情</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询动态详情SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    m.id <span class="keyword">as</span> id,m.content content,m.ctrateTime ctrateTime,m.updateTime updateTime,</span><br><span class="line">    <span class="built_in">JSON_OBJECT</span>(<span class="string">&#x27;id&#x27;</span>,u.id,<span class="string">&#x27;name&#x27;</span>,u.name) <span class="keyword">as</span> userInfo</span><br><span class="line">    <span class="keyword">FROM</span> moment <span class="keyword">as</span> m</span><br><span class="line">    <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> <span class="keyword">user</span> <span class="keyword">as</span> u <span class="keyword">ON</span> u.id<span class="operator">=</span>m.user_id</span><br><span class="line">    <span class="keyword">WHERE</span> m.id<span class="operator">=</span><span class="number">3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询评论列表SQL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `comment` <span class="keyword">WHERE</span> `comment`.moment_id<span class="operator">=</span><span class="number">3</span></span><br><span class="line"><span class="comment">-- 可以将两者查询出来,然后使用JS进行拼接处理;</span></span><br></pre></td></tr></table></figure>

<h2 id="标签动态接口-多对多"><a href="#标签动态接口-多对多" class="headerlink" title="标签动态接口(多对多)"></a>标签动态接口(多对多)</h2><blockquote>
<p>设计表字段思路：标签对应了哪条动态；没人在意标签是谁建的；</p>
<p>一个标签可以对应多条动态，一条动态可以有个标签；</p>
<p>属于”多对多”关系型数据库表；</p>
</blockquote>
<h3 id="数据库表-2"><a href="#数据库表-2" class="headerlink" title="数据库表"></a>数据库表</h3><ul>
<li>标签表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> label(</span><br><span class="line">id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">name <span class="type">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">ctrateTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">updateTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>关系表(记录标签，动态的关系)</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> moment_label(</span><br><span class="line"><span class="comment">-- id INT PRIMARY KEY AUTO_INCREMENT, -- 这里使用联合主键,当然也可以用id</span></span><br><span class="line">moment_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">label_id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY(moment_id,label_id),<span class="comment">-- 联合主键</span></span><br><span class="line">ctrateTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">updateTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line"><span class="keyword">FOREIGN</span> KEY(moment_id) <span class="keyword">REFERENCES</span> moment(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE,</span><br><span class="line"><span class="keyword">FOREIGN</span> KEY(label_id) <span class="keyword">REFERENCES</span> label(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>多对多，三张表，关系表加外键；</li>
<li>添加数据时，先添加父表记录(moment，label)，再添加子表(moment_label)记录；</li>
<li>删除数据时，先删除子表记录(moment_label)，再删除父表记录(moment，label)；</li>
<li>详细代码：可参考上文接口；仅是sql语句更变了；</li>
</ul>
<h2 id="文件处理接口"><a href="#文件处理接口" class="headerlink" title="文件处理接口"></a>文件处理接口</h2><h3 id="上传头像"><a href="#上传头像" class="headerlink" title="上传头像"></a>上传头像</h3><ul>
<li>安装处理文件的库</li>
</ul>
<blockquote>
<p><code>npm i koa-multer</code>的时候给出警告: Please use @koa&#x2F;multer instead；</p>
<p>通过查阅github发现：koa-multer在2018年就不再维护，但是koa官方自己研发了相关multer库：<a target="_blank" rel="noopener" href="https://github.com/koajs/multer">@koa&#x2F;multer</a>，这里使用官方推荐的；</p>
<p>相对于koa-multer，koa&#x2F;multer仅仅在获取文件的方式从ctx.req.file–&gt;ctx.request.file；别的用法和koa-multer一致；</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save @koa/multer multer</span><br></pre></td></tr></table></figure>

<h4 id="基本逻辑"><a href="#基本逻辑" class="headerlink" title="基本逻辑"></a>基本逻辑</h4><ul>
<li><code>router</code>文件夹下新建<code>file.router.js</code>，用来存放上传头像的路由逻辑；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; vertifyToken &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; handleAvatar &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/handleAvatar.middleware.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; uploadAvatar &#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/file.controller.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fileRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/file&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">fileRouter.<span class="title function_">post</span>(<span class="string">&quot;/avatar&quot;</span>, vertifyToken, handleAvatar, uploadAvatar);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = fileRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>middleware</code>文件夹下新建<code>handleAvatar.middleware.js</code>，用来存放上传头像中间件的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&quot;@koa/multer&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> uploadAvatars = <span class="title function_">multer</span>(&#123;</span><br><span class="line">  <span class="comment">// 注意这里的./是和程序的启动目录有关系的，不是当前目录</span></span><br><span class="line">  <span class="attr">dest</span>: <span class="string">&quot;./uploads/&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handleAvatar = uploadAvatars.<span class="title function_">single</span>(<span class="string">&quot;avatar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  handleAvatar,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下新建<code>file.controller.js</code>，用来存放上传头像的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">uploadAvatar</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> files = ctx.<span class="property">request</span>.<span class="property">file</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(files);</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;上传成功&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">FileController</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**console.log(files)的打印:</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  fieldname: &#x27;avatar&#x27;,</span></span><br><span class="line"><span class="comment">  originalname: &#x27;default_cover_7.webp&#x27;,</span></span><br><span class="line"><span class="comment">  encoding: &#x27;7bit&#x27;,</span></span><br><span class="line"><span class="comment">  mimetype: &#x27;image/webp&#x27;,</span></span><br><span class="line"><span class="comment">  destination: &#x27;./uploads/&#x27;,</span></span><br><span class="line"><span class="comment">  filename: &#x27;7a30342648914762d1cc040219d2a6e1&#x27;,</span></span><br><span class="line"><span class="comment">  path: &#x27;uploads\\7a30342648914762d1cc040219d2a6e1&#x27;,</span></span><br><span class="line"><span class="comment">  size: 382920</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>使用postman请求<code>/file/avatar</code>(POST)，form-data选择File，key为avatar，value为上传的头像；发现项目自动创建了uploads文件夹，里面包含了上传的头像。</p>
<h4 id="数据库表-3"><a href="#数据库表-3" class="headerlink" title="数据库表"></a>数据库表</h4><blockquote>
<p>根据file信息，挑选几个有用的字段进行保存，还需要将上传头像的用户ID进行保存，后续为了给这个人设置头像；</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `avatar`(</span><br><span class="line"> id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line"> filename <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line"> mimetype <span class="type">VARCHAR</span>(<span class="number">30</span>),</span><br><span class="line"> size <span class="type">INT</span>,</span><br><span class="line"> user_id <span class="type">INT</span>,</span><br><span class="line"> ctrateTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line"> updateTime <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line"> <span class="keyword">FOREIGN</span> KEY(user_id) <span class="keyword">REFERENCES</span> <span class="keyword">user</span>(id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="插入数据-1"><a href="#插入数据-1" class="headerlink" title="插入数据"></a>插入数据</h4><ul>
<li>在基础逻辑上，在<code>controller</code>文件夹下<code>file.controller.js</code>中，优化存放上传头像的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> serviceFile = <span class="built_in">require</span>(<span class="string">&quot;../service/file.service&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">uploadAvatar</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> files = ctx.<span class="property">request</span>.<span class="property">file</span>;</span><br><span class="line">    <span class="comment">// console.log(files);</span></span><br><span class="line">    <span class="comment">// 1.获取相应的信息</span></span><br><span class="line">    <span class="keyword">const</span> &#123;filename,mimetype,size &#125; = ctx.<span class="property">request</span>.<span class="property">file</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123;id&#125; = ctx.<span class="property">userInfo</span>;</span><br><span class="line">    <span class="comment">// 2.保存到数据库</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> serviceFile.<span class="title function_">uploadAvatar</span>(filename,mimetype,size,id);</span><br><span class="line">    <span class="comment">// 3.返回</span></span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;上传成功&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: result,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">FileController</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下新建<code>file.service.js</code>，用来存放上传头像的SQL逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileService</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">uploadAvatar</span>(<span class="params">filename,mimetype,size,userId</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> statement = <span class="string">`INSERT INTO avatar (filename,mimetype,size,user_id) VALUES (?,?,?,?)`</span>;</span><br><span class="line">        <span class="keyword">const</span> [result] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[filename,mimetype,size,userId]);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">FileService</span>();</span><br></pre></td></tr></table></figure>

<h3 id="浏览头像"><a href="#浏览头像" class="headerlink" title="浏览头像"></a>浏览头像</h3><blockquote>
<p>现在头像是没办法浏览的；现在提供一个浏览头像的接口；</p>
</blockquote>
<ul>
<li>因为头像是user的，所以这里选择在user下提供浏览头像的接口；<code>router</code>文件夹下的<code>user.router.js</code>，用来提供一个浏览头像的接口；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/users&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> &#123;verifyUser,handlePassword&#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/user.middleware.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;create,showAvatarImage&#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/user.controller.js&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册用户</span></span><br><span class="line">userRouter.<span class="title function_">post</span>(<span class="string">&quot;/&quot;</span>,verifyUser,handlePassword, create);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为用户提供头像展示(看图片不需要验证权限)</span></span><br><span class="line">userRouter.<span class="title function_">get</span>(<span class="string">&quot;/avatar/:userId&quot;</span>,showAvatarImage)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = userRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下的<code>user.controller.js</code>，用来处理用户头像展示的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs= <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&quot;../service/user.service.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fileService = <span class="built_in">require</span>(<span class="string">&quot;../service/file.service.js&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">  <span class="comment">// 因为操作数据库是异步操作的,所以直接用 async 函数; async函数为对象的方法,下面直接module导出了一个对象;</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取用户请求传递的参数</span></span><br><span class="line">    <span class="keyword">const</span> user = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 查询数据</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">create</span>(user);</span><br><span class="line">    <span class="comment">// 返回数据</span></span><br><span class="line">    ctx.<span class="property">body</span> = result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用户头像展示</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">showAvatarImage</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 1.获取用户的id</span></span><br><span class="line">    <span class="keyword">const</span> &#123; userId &#125; = ctx.<span class="property">params</span>;</span><br><span class="line">    <span class="comment">// 2.获取userID对应的头像信息</span></span><br><span class="line">    <span class="keyword">const</span> avatarInfo = <span class="keyword">await</span> fileService.<span class="title function_">showAvatarImageById</span>(userId);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(avatarInfo)</span><br><span class="line">    <span class="comment">// 3.读取头像所在的文件</span></span><br><span class="line">    <span class="keyword">const</span> &#123; filename, mimetype &#125; = avatarInfo;</span><br><span class="line">    <span class="comment">// 创建一个可读流</span></span><br><span class="line">    ctx.<span class="property">body</span> = fs.<span class="title function_">createReadStream</span>(<span class="string">`./uploads/<span class="subst">$&#123;filename&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// 设置响应头信息</span></span><br><span class="line">    ctx.<span class="title function_">set</span>(<span class="string">&quot;Content-Type&quot;</span>, mimetype);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>(); <span class="comment">//导出的是一个对象(类的实例)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下的<code>file.service.js</code>，用来做用户头像展示的SQL逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileService</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">uploadAvatar</span>(<span class="params">filename,mimetype,size,userId</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> statement = <span class="string">`INSERT INTO avatar (filename,mimetype,size,user_id) VALUES (?,?,?,?)`</span>;</span><br><span class="line">        <span class="keyword">const</span> [result] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[filename,mimetype,size,userId]);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">showAvatarImageById</span>(<span class="params">userId</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM avatar WHERE user_id=?`</span>;</span><br><span class="line">        <span class="keyword">const</span> [result] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[userId]);</span><br><span class="line">        <span class="comment">// 用户可能上传多张头像,所以result数组里面展示最后一个对象;</span></span><br><span class="line">        <span class="keyword">return</span> result[result.<span class="property">length</span>-<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">FileService</span>();</span><br></pre></td></tr></table></figure>

<p>浏览器通过<code>http://127.0.0.1:3000/users/avatar/1</code>；或者postman通过<code>/users/avatar/1</code>即可查阅图片；</p>
<h4 id="修改user表"><a href="#修改user表" class="headerlink" title="修改user表"></a>修改user表</h4><blockquote>
<p>在user表中，增加一个avatar_url字段；</p>
</blockquote>
<ul>
<li><code>controller</code>文件夹下的<code>file.controller.js</code>，用来处理上传用户头像存储的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> serviceFile = <span class="built_in">require</span>(<span class="string">&quot;../service/file.service&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> userService = <span class="built_in">require</span>(<span class="string">&quot;../service/user.service&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">SERVER_HOST</span>,<span class="variable constant_">APP_PORT</span>&#125; = <span class="built_in">require</span>(<span class="string">&quot;../app/config&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">uploadAvatar</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> files = ctx.<span class="property">request</span>.<span class="property">file</span>;</span><br><span class="line">    <span class="comment">// console.log(files);</span></span><br><span class="line">    <span class="comment">// 1.获取相应的信息</span></span><br><span class="line">    <span class="keyword">const</span> &#123;filename,mimetype,size &#125; = ctx.<span class="property">request</span>.<span class="property">file</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123;id&#125; = ctx.<span class="property">userInfo</span>;</span><br><span class="line">    <span class="comment">// 2.保存到数据库</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> serviceFile.<span class="title function_">uploadAvatar</span>(filename,mimetype,size,id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.将头像地址信息在user表中也存储一份;</span></span><br><span class="line">    <span class="keyword">const</span> avatar_url = <span class="string">`<span class="subst">$&#123;SERVER_HOST&#125;</span>:<span class="subst">$&#123;APP_PORT&#125;</span>/users/avatar/<span class="subst">$&#123;id&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> userResult = <span class="keyword">await</span> userService.<span class="title function_">updateUserAvatar</span>(avatar_url,id);</span><br><span class="line">    <span class="comment">// 3.返回</span></span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;上传成功&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: avatar_url,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">FileController</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下的<code>user.service.js</code>，用来做更新用户头像地址的SQL逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connections = <span class="built_in">require</span>(<span class="string">&quot;../app/database.js&quot;</span>);</span><br><span class="line"><span class="comment">// 专门做数据库操作的;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// 更新用户头像地址</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">updateUserAvatar</span>(<span class="params">avatarUrl,userId</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> statement = <span class="string">`UPDATE user SET avatar_url=? WHERE id=?`</span>;</span><br><span class="line">        <span class="keyword">const</span> [result] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[avatarUrl,userId]);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下的<code>file.controller.js</code>，返回头像地址需要写到配置文件里</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># .<span class="property">env</span></span><br><span class="line"><span class="variable constant_">APP_PORT</span>=<span class="number">3000</span></span><br><span class="line"><span class="variable constant_">SERVER_HOST</span>=<span class="attr">http</span>:<span class="comment">//192.168.11.242</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>app</code>文件夹下的<code>config.js</code>将配置文件中的变量暴露出去；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="variable constant_">APP_PORT</span></span><br><span class="line">    <span class="variable constant_">SERVER_HOST</span></span><br><span class="line">&#125; = process.<span class="property">env</span>;</span><br></pre></td></tr></table></figure>

<p>请求<code>/file/avatar</code>(POST)上传文件，如果成功，返回结果如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;上传成功&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: <span class="string">&quot;http://192.168.11.242:3000/users/avatar/1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 通过访问http://192.168.11.242:3000/users/avatar/1(接口),访问图片。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>但是吧，这个跟我们平时见到的图片地址不一样，我们平时见到的图片地址是xx.jpg&#x2F;png结尾的，而不是上面这种。下面讲述一下如何展示图片地址是xx.jpg&#x2F;png结尾的。</p>
</blockquote>
<h3 id="上传头像2"><a href="#上传头像2" class="headerlink" title="上传头像2"></a>上传头像2</h3><p>参考文献：<a target="_blank" rel="noopener" href="https://blog.csdn.net/LQlove1/article/details/128698984">koa-multer实现图片上传</a>；<a target="_blank" rel="noopener" href="https://blog.csdn.net/zy21131437/article/details/130440198">Koa实现图片上传功能</a>；<a target="_blank" rel="noopener" href="https://juejin.cn/post/7033290552523096078">koa处理上传图片</a>；</p>
<blockquote>
<p>常见图片后缀的展示，需要用到node自带的path模块和static模块和第三方包koa&#x2F;multer；</p>
<p>在avatar表中，现在的filename是存储的类似于<code>e91b35e24586c1cb208a544f6acb5961</code>的图片信息，需要改为存储有后缀名的filename。</p>
<p>这里问了公司后端：filename一般都是设置为UNIQUE，且不会保留前端传过来的本身的文件名；因为如果传过来两个一样的文件名，后端不知道返回哪个；除非已经做好命名规范，可不设置为UNIQUE；</p>
<p>即：上传的文件名一般不保存，除非约定好了上传的文件名唯一；</p>
</blockquote>
<ul>
<li>安装所需依赖</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install koa<span class="operator">-</span><span class="keyword">static</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>router</code>文件夹下<code>file.router.js</code>，新写一个上传头像的路由逻辑；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; vertifyToken &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/auth.middleware.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; handleAvatar,handleAvatar2 &#125; = <span class="built_in">require</span>(<span class="string">&quot;../middleware/handleAvatar.middleware.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; uploadAvatar,uploadAvatar2 &#125; = <span class="built_in">require</span>(<span class="string">&quot;../controller/file.controller.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fileRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&quot;/file&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传头像,没有常见的后缀名,即通过接口访问图片地址，不需要后缀</span></span><br><span class="line">fileRouter.<span class="title function_">post</span>(<span class="string">&quot;/avatar&quot;</span>, vertifyToken, handleAvatar, uploadAvatar);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传头像，有常见的后缀名</span></span><br><span class="line">fileRouter.<span class="title function_">post</span>(<span class="string">&quot;/avatar2&quot;</span>, vertifyToken, handleAvatar2, uploadAvatar2);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = fileRouter;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>middleware</code>文件夹下的<code>handleAvatar.middleware.js</code>，新写一个存放上传头像中间件的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&quot;@koa/multer&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> uploadAvatars = <span class="title function_">multer</span>(&#123;</span><br><span class="line">  <span class="comment">// 注意这里的./是和程序的启动目录有关系的，不是当前目录</span></span><br><span class="line">  <span class="attr">dest</span>: <span class="string">&quot;./uploads/&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handleAvatar = uploadAvatars.<span class="title function_">single</span>(<span class="string">&quot;avatar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传头像，有常见的后缀名</span></span><br><span class="line"><span class="keyword">const</span> storage = multer.<span class="title function_">diskStorage</span>(&#123;</span><br><span class="line">  <span class="attr">destination</span>: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 可以用 path.join(__dirname ,&#x27;xxx&#x27;)拼接,就不用考虑相对路径的问题了;</span></span><br><span class="line">    <span class="title function_">cb</span>(<span class="literal">null</span>, <span class="string">&quot;./uploads/&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 这里一般不会保留原来的,否则会导致后端不知道返回啥;除非约定好了</span></span><br><span class="line">  <span class="attr">filename</span>: <span class="function">(<span class="params">req, file, cb</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">cb</span>(<span class="literal">null</span>, <span class="title class_">Date</span>.<span class="title function_">now</span>() + path.<span class="title function_">extname</span>(file.<span class="property">originalname</span>));</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> uploadAvatars2 = <span class="title function_">multer</span>(&#123;</span><br><span class="line">  storage,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> handleAvatar2 = uploadAvatars2.<span class="title function_">single</span>(<span class="string">&quot;avatar2&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  handleAvatar,</span><br><span class="line">  handleAvatar2,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>controller</code>文件夹下的<code>file.controller.js</code>，新写一个存放上传头像的逻辑处理；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> serviceFile = <span class="built_in">require</span>(<span class="string">&quot;../service/file.service&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> userService = <span class="built_in">require</span>(<span class="string">&quot;../service/user.service&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="variable constant_">SERVER_HOST</span>, <span class="variable constant_">APP_PORT</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;../app/config&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileController</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">uploadAvatar</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> files = ctx.<span class="property">request</span>.<span class="property">file</span>;</span><br><span class="line">    <span class="comment">// console.log(files);</span></span><br><span class="line">    <span class="comment">// 1.获取相应的信息</span></span><br><span class="line">    <span class="keyword">const</span> &#123; filename, mimetype, size &#125; = ctx.<span class="property">request</span>.<span class="property">file</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = ctx.<span class="property">userInfo</span>;</span><br><span class="line">    <span class="comment">// 2.保存到数据库</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> serviceFile.<span class="title function_">uploadAvatar</span>(filename, mimetype, size, id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.将头像地址信息在user表中也存储一份;</span></span><br><span class="line">    <span class="keyword">const</span> avatar_url = <span class="string">`<span class="subst">$&#123;SERVER_HOST&#125;</span>:<span class="subst">$&#123;APP_PORT&#125;</span>/users/avatar/<span class="subst">$&#123;id&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">await</span> userService.<span class="title function_">updateUserAvatar</span>(avatar_url, id);</span><br><span class="line">    <span class="comment">// 3.返回</span></span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;上传成功&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: avatar_url,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 有后缀名的头像</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">uploadAvatar2</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> files = ctx.<span class="property">request</span>.<span class="property">file</span>;</span><br><span class="line">    <span class="comment">// console.log(files);</span></span><br><span class="line">    <span class="comment">// 1.获取相应的信息</span></span><br><span class="line">    <span class="keyword">const</span> &#123; filename, mimetype, size &#125; = ctx.<span class="property">request</span>.<span class="property">file</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = ctx.<span class="property">userInfo</span>;</span><br><span class="line">    <span class="comment">// 2.保存到数据库</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> serviceFile.<span class="title function_">uploadAvatar</span>(filename, mimetype, size, id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.将头像地址信息在user表中也存储一份;</span></span><br><span class="line">    <span class="keyword">const</span> avatar_url = <span class="string">`<span class="subst">$&#123;SERVER_HOST&#125;</span>:<span class="subst">$&#123;APP_PORT&#125;</span>/<span class="subst">$&#123;filename&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">await</span> userService.<span class="title function_">updateUserAvatar</span>(avatar_url, id);</span><br><span class="line">    <span class="comment">// 3.返回</span></span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;上传成功&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: avatar_url,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">FileController</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>service</code>文件夹下的<code>user.service.js</code>，用来做更新用户头像地址的SQL逻辑处理；(这个没有变)；相对于通过接口显示图片，有后缀的是通过koa-static展示的，所以可以不用专门写一个接口浏览头像；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 更新用户头像地址</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">updateUserAvatar</span>(<span class="params">avatarUrl,userId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`UPDATE user SET avatar_url=? WHERE id=?`</span>;</span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connections.<span class="title function_">execute</span>(statement,[avatarUrl,userId]);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>koa-static静态服务：在<code>app</code>文件夹下的<code>index.js</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path =<span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-static&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> useRoutes = <span class="built_in">require</span>(<span class="string">&quot;../router/index.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser= <span class="built_in">require</span>(<span class="string">&quot;koa-bodyparser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> errorHandler = <span class="built_in">require</span>(<span class="string">&quot;./errorHandler.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>());</span><br><span class="line"><span class="comment">// 注册路由</span></span><br><span class="line"><span class="title function_">useRoutes</span>(app); <span class="comment">//传参app参数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态资源服务</span></span><br><span class="line"><span class="keyword">const</span> filePath = path.<span class="title function_">resolve</span>(__dirname,<span class="string">&quot;../../uploads&quot;</span>);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">static</span>(filePath));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误处理</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>,errorHandler);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app;</span><br></pre></td></tr></table></figure>

<p>请求<code>/file/avatar2</code>(POST)，文件格式选：form-data(File)，key为avatar2，value为文件；返回结果为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;上传成功&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: <span class="string">&quot;http://192.168.11.242:3000/1698373200499.webp&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 浏览器访问图片地址,能直接访问,则成功;</span></span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://fsllala.top">Forward</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://fsllala.top/articles/5157567c.html">https://fsllala.top/articles/5157567c.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://fsllala.top" target="_blank">Forward の Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/NodeJs-Koa2/">NodeJs Koa2</a></div><div class="post_share"><div class="social-share" data-image="https://cover.fsllala.top/default_cover_45.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/articles/65b69107.html"><img class="prev-cover" src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_43.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Nginx</div></div></a></div><div class="next-post pull-right"><a href="/articles/fa0f2f9c.html"><img class="next-cover" src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_57.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">网络安全修改</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/articles/799084bf.html" title="NodeJs Koa2"><img class="cover" src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_9.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-29</div><div class="title">NodeJs Koa2</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="author_top is-center"><div class="avatar-img"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://img.fsllala.top/1656236729350avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Forward</div><div class="author-info__description">记录一些知识点🥝</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">49</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">59</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">55</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/fsllala"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/fsllala" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://gitee.com/fsllala" target="_blank" title="Gitee"><i class="fa-brands fa-git-square"></i></a><a class="social-icon" href="mailto:1779318132@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"></div><div id="welcome-info"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#koa2%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="toc-number">1.</span> <span class="toc-text">koa2项目实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">项目的搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E7%9A%84%E5%88%92%E5%88%86"><span class="toc-number">1.1.1.</span> <span class="toc-text">目录结构的划分</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">安装依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%BF%AB%E6%8D%B7%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">设置快捷启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">入口文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6%E6%8B%86%E5%88%86"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">入口文件拆分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.2.</span> <span class="toc-text">用户注册接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80%E5%86%99%E6%B3%95"><span class="toc-number">1.2.1.</span> <span class="toc-text">架构基础写法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E8%BF%9B%E9%98%B6%E5%86%99%E6%B3%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">架构进阶写法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E6%8B%86%E5%88%86"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">路由拆分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%8B%86%E5%88%86"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">路由中间件拆分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8B%86%E5%88%86"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">路由中间件操作数据库拆分</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.2.3.</span> <span class="toc-text">连接数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96-1"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">安装依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">创建连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">插入数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">错误处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%94%A8%E6%88%B7%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E6%B3%A8%E5%86%8C"><span class="toc-number">1.2.3.5.</span> <span class="toc-text">查看用户是否已经注册</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86"><span class="toc-number">1.2.3.6.</span> <span class="toc-text">密码加密</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.3.</span> <span class="toc-text">用户登录接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91%E7%BB%93%E6%9E%84%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.1.</span> <span class="toc-text">登录逻辑结构搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.3.2.</span> <span class="toc-text">登录条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8C%96%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.3.3.</span> <span class="toc-text">简化路由注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E5%87%AD%E8%AF%81"><span class="toc-number">1.3.4.</span> <span class="toc-text">登录凭证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E7%99%BB%E5%BD%95%E5%87%AD%E8%AF%81%E5%91%A2%EF%BC%9F"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">为什么需要登录凭证呢？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT%E9%A2%81%E5%8F%91%E7%AD%BE%E5%90%8D"><span class="toc-number">1.3.5.</span> <span class="toc-text">JWT颁发签名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BF%A1%E6%81%AF%E6%8E%A5%E5%8F%A3-%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">1.4.</span> <span class="toc-text">动态信息接口(一对多)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-number">1.4.1.</span> <span class="toc-text">数据库表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E8%A1%A8%E5%8A%A8%E6%80%81"><span class="toc-number">1.4.2.</span> <span class="toc-text">发表动态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%8A%A8%E6%80%81%E5%88%97%E8%A1%A8"><span class="toc-number">1.4.3.</span> <span class="toc-text">查询动态列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%8A%A8%E6%80%81%E8%AF%A6%E6%83%85"><span class="toc-number">1.4.4.</span> <span class="toc-text">查询动态详情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%8A%A8%E6%80%81"><span class="toc-number">1.4.5.</span> <span class="toc-text">修改动态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%8A%A8%E6%80%81"><span class="toc-number">1.4.6.</span> <span class="toc-text">删除动态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%84%E8%AE%BA%E5%8A%A8%E6%80%81%E6%8E%A5%E5%8F%A3-%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">1.5.</span> <span class="toc-text">评论动态接口(一对多)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8-1"><span class="toc-number">1.5.1.</span> <span class="toc-text">数据库表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E8%A1%A8%E8%AF%84%E8%AE%BA"><span class="toc-number">1.5.2.</span> <span class="toc-text">发表评论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E5%A4%8D%E8%AF%84%E8%AE%BA"><span class="toc-number">1.5.3.</span> <span class="toc-text">回复评论</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BF%A1%E6%81%AF%E4%B8%8E%E8%AF%84%E8%AE%BA%E6%8E%A5%E5%8F%A3-%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">1.6.</span> <span class="toc-text">动态信息与评论接口(一对多)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%8A%A8%E6%80%81%E5%88%97%E8%A1%A8-1"><span class="toc-number">1.6.1.</span> <span class="toc-text">查询动态列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%8A%A8%E6%80%81%E8%AF%A6%E6%83%85-1"><span class="toc-number">1.6.2.</span> <span class="toc-text">查询动态详情</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%87%E7%AD%BE%E5%8A%A8%E6%80%81%E6%8E%A5%E5%8F%A3-%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="toc-number">1.7.</span> <span class="toc-text">标签动态接口(多对多)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8-2"><span class="toc-number">1.7.1.</span> <span class="toc-text">数据库表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.8.</span> <span class="toc-text">文件处理接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E5%A4%B4%E5%83%8F"><span class="toc-number">1.8.1.</span> <span class="toc-text">上传头像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E9%80%BB%E8%BE%91"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">基本逻辑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8-3"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">数据库表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE-1"><span class="toc-number">1.8.1.3.</span> <span class="toc-text">插入数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%A4%B4%E5%83%8F"><span class="toc-number">1.8.2.</span> <span class="toc-text">浏览头像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9user%E8%A1%A8"><span class="toc-number">1.8.2.1.</span> <span class="toc-text">修改user表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E5%A4%B4%E5%83%8F2"><span class="toc-number">1.8.3.</span> <span class="toc-text">上传头像2</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/articles/69bf273.html" title="SSE"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_74.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SSE"/></a><div class="content"><a class="title" href="/articles/69bf273.html" title="SSE">SSE</a><time datetime="2025-06-23T17:24:24.000Z" title="发表于 2025-06-24 01:24:24">2025-06-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/a7bb958f.html" title="AI"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_65.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AI"/></a><div class="content"><a class="title" href="/articles/a7bb958f.html" title="AI">AI</a><time datetime="2025-05-23T15:23:23.000Z" title="发表于 2025-05-23 23:23:23">2025-05-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/85097e63.html" title="前端如何实现自动检测更新？"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://bu.dusays.com/2021/12/31/623a20222e385.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="前端如何实现自动检测更新？"/></a><div class="content"><a class="title" href="/articles/85097e63.html" title="前端如何实现自动检测更新？">前端如何实现自动检测更新？</a><time datetime="2024-08-08T00:08:08.000Z" title="发表于 2024-08-08 08:08:08">2024-08-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/8a15ea5f.html" title="缓存"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_69.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="缓存"/></a><div class="content"><a class="title" href="/articles/8a15ea5f.html" title="缓存">缓存</a><time datetime="2024-06-05T22:16:26.000Z" title="发表于 2024-06-06 06:16:26">2024-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/articles/b9f20a20.html" title="webpack"><img src= "https://img.fsllala.top/loading.gif" data-lazy-src="https://cover.fsllala.top/default_cover_64.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="webpack"/></a><div class="content"><a class="title" href="/articles/b9f20a20.html" title="webpack">webpack</a><time datetime="2024-01-03T12:15:07.000Z" title="发表于 2024-01-03 20:15:07">2024-01-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Forward</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0</span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://netlify.fsllala.top/js/fancybox.umd.min.js"></script><script src="https://netlify.fsllala.top/js/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://netlify.fsllala.top/js/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.fsllala.top',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.fsllala.top',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="/js/jquery.min.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/cursor.js"></script><script defer data-pjax src="/js/cat.js"></script><script defer data-pjax src="/js/readPercent.js"></script><script async data-pjax src="/js/txMap.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://netlify.fsllala.top/js/canvas-nest.min.js"></script><script src="https://netlify.fsllala.top/js/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://netlify.fsllala.top/js/click-heart.min.js" async="async" mobile="false"></script><script src="https://netlify.fsllala.top/js/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html><div id="web_bg"></div>